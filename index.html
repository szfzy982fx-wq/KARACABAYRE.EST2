<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KARACABAYRE.EST v29</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #2c3e50; --secondary: #3498db; --accent: #27ae60;
            --danger: #c0392b; --warning: #f39c12; --light: #f8f9fa;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f3; margin: 0; padding: 10px; color: #333; }
        
        /* GÄ°RÄ°Å EKRANI */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .login-box { background: white; padding: 30px; border-radius: 10px; text-align: center; width: 300px; }
        .login-box input { width: 80%; padding: 10px; margin: 15px 0; font-size: 18px; text-align: center; border: 2px solid #ddd; border-radius: 5px; }
        .login-box button { width: 90%; padding: 10px; background: var(--accent); color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }

        /* ANA EKRAN (v27 STÄ°LÄ°) */
        #appContainer { display: none; max-width: 1800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
        
        /* BUTONLAR */
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.2s; }
        .btn-primary { background: var(--secondary); color: white; }
        .btn-success { background: var(--accent); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-warning { background: var(--warning); color: white; }
        .btn-tool { background: white; border: 1px solid #ccc; color: var(--primary); display: flex; align-items: center; gap: 5px; }
        .btn-tool:hover { background: var(--light); border-color: var(--secondary); color: var(--secondary); }
        .btn-pro { background: #e8f8f5; border: 1px solid #1abc9c; color: #16a085; }
        .btn-pro:hover { background: #16a085; color: white; }

        /* INPUTS */
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; }
        .form-group label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 5px; color: #555; text-transform: uppercase; }

        /* TABLO (v27) */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f9f9f9; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 11px; font-weight: bold; }
        .satilik { background: var(--secondary); } .kiralik { background: var(--warning); } .satildi { background: var(--sold); }

        /* MODAL (Ortak) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; overflow-y: hidden; }
        .modal-content { background: white; margin: 2vh auto; width: 95%; max-width: 1200px; height: 96vh; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; }
        .modal-header { padding: 15px; background: var(--light); border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 15px; background: var(--light); border-top: 1px solid #ddd; display: flex; gap: 10px; justify-content: flex-end; }

        /* v3.8 TAB SÄ°STEMÄ° (CSS ile yeniden yazÄ±ldÄ±) */
        .tab-nav { display: flex; gap: 5px; border-bottom: 2px solid #eee; margin-bottom: 20px; overflow-x: auto; }
        .tab-btn { padding: 10px 20px; background: none; border: none; border-bottom: 3px solid transparent; cursor: pointer; font-weight: bold; color: #777; white-space: nowrap; }
        .tab-btn.active { color: var(--secondary); border-bottom-color: var(--secondary); background: #fdfdfd; }
        .tab-pane { display: none; animation: fadeIn 0.3s; }
        .tab-pane.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Ã–ZELLÄ°K SEÃ‡Ä°M KUTULARI (Checkbox) */
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 8px; margin-top: 10px; }
        .feature-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8f9fa; border: 1px solid #eee; border-radius: 4px; font-size: 13px; cursor: pointer; }
        .feature-item:hover { background: #eaf2f8; }
        .feature-item input { width: auto; margin: 0; }

        /* HARÄ°TA KUTUSU */
        #mapCanvas { width: 100%; height: 400px; border-radius: 8px; border: 1px solid #ccc; z-index: 1; }
        
        /* RAPOR Ã‡IKTI ALANI (GÄ°ZLÄ°) */
        #printArea { display: none; }
        @media print {
            body > * { display: none !important; }
            #printArea { display: block !important; position: absolute; top: 0; left: 0; width: 100%; background: white; padding: 20px; }
            #printArea * { display: block; }
            .no-print { display: none !important; }
            .print-flex { display: flex !important; gap: 20px; }
            .print-col { flex: 1; }
            .doc-title { font-size: 24px; color: var(--primary); font-weight: bold; margin-bottom: 5px; }
            .doc-price { font-size: 28px; color: var(--accent); font-weight: bold; margin-bottom: 20px; }
            .doc-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
            .doc-table td { border-bottom: 1px solid #eee; padding: 5px; font-size: 12px; }
            .doc-label { font-weight: bold; width: 120px; color: #555; }
        }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2>ğŸ”’ GÃœVENLÄ° GÄ°RÄ°Å</h2>
        <p>KaracabayRE.EST v29</p>
        <input type="password" id="loginPin" placeholder="Åifre (1923)" inputmode="numeric">
        <button onclick="if(document.getElementById('loginPin').value==='1923'){document.getElementById('loginOverlay').style.display='none';document.getElementById('appContainer').style.display='block';}else{alert('HatalÄ±!');}">GÄ°RÄ°Å YAP</button>
    </div>
</div>

<div id="appContainer">
    <header>
        <h3>ğŸ¢ KARACABAYRE.EST <span style="font-size:12px; background:var(--accent); color:white; padding:2px 8px; border-radius:10px;">HIBRT v29</span></h3>
        <div>
            <input type="file" id="fileIn" style="display:none" onchange="importData(this)">
            <button class="btn btn-warning" onclick="document.getElementById('fileIn').click()">YÃœKLE</button>
            <button class="btn btn-warning" onclick="exportData()">YEDEKLE</button>
        </div>
    </header>

    <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); margin-bottom: 20px;">
        <button class="btn btn-tool btn-pro" onclick="openProModal()"><i class="fa-solid fa-file-contract"></i> <b>DETAYLI RAPOR (v3.8)</b></button>
        <button class="btn btn-tool" onclick="alert('v27 HÄ±zlÄ± KayÄ±t Modu Aktif')"><i class="fa-solid fa-bolt"></i> HÄ±zlÄ± KayÄ±t</button>
        <a href="https://parselsorgu.tkgm.gov.tr/" target="_blank" class="btn btn-tool"><i class="fa-solid fa-map"></i> TKGM</a>
        <a href="https://www.tcmb.gov.tr/" target="_blank" class="btn btn-tool"><i class="fa-solid fa-money-bill"></i> Kur</a>
    </div>

    <div style="background:var(--light); padding:15px; border-radius:8px;">
        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); margin-bottom:15px;">
            <input type="text" id="search" placeholder="ğŸ” Ara..." onkeyup="renderTable()">
            <select id="fType" onchange="renderTable()"><option value="all">TÃ¼m Tipler</option></select>
            <select id="fDist" onchange="renderTable()"><option value="all">TÃ¼m Ä°lÃ§eler</option></select>
            <button class="btn btn-primary" onclick="renderTable()">YENÄ°LE</button>
        </div>
        <table>
            <thead><tr><th>TÃ¼r/Durum</th><th>Lokasyon</th><th>Ã–zellikler</th><th>Fiyat</th><th>YÃ¶netim</th></tr></thead>
            <tbody id="listBody"></tbody>
        </table>
    </div>
</div>

<div id="proModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>ğŸ“‘ DetaylÄ± PortfÃ¶y YÃ¶netimi (v3.8 Modu)</h3>
            <button class="btn btn-danger" onclick="closeProModal()">KAPAT</button>
        </div>
        <div class="modal-body">
            <div class="tab-nav">
                <button class="tab-btn active" onclick="showTab('tab-kimlik')">1. Kimlik & Finans</button>
                <button class="tab-btn" onclick="showTab('tab-teknik')">2. Teknik Detay</button>
                <button class="tab-btn" onclick="showTab('tab-konum'); fixMap();">3. Konum & Harita</button>
                <button class="tab-btn" onclick="showTab('tab-ozellik')">4. Ã–zellikler</button>
                <button class="tab-btn" onclick="showTab('tab-medya')">5. Medya & Ã‡Ä±ktÄ±</button>
            </div>

            <input type="hidden" id="recId">

            <div id="tab-kimlik" class="tab-pane active">
                <div style="background:#fff3cd; padding:10px; margin-bottom:15px; border-left:4px solid #f39c12;">
                    <strong>ğŸ”’ GÄ°ZLÄ° YÃ–NETÄ°CÄ° ALANI</strong>
                    <div class="form-grid">
                        <input type="text" id="owner" placeholder="Mal Sahibi Ad Soyad">
                        <input type="text" id="ownerTel" placeholder="Telefon">
                        <input type="date" id="authStart" title="Yetki BaÅŸlangÄ±Ã§">
                        <input type="date" id="authEnd" title="Yetki BitiÅŸ">
                    </div>
                </div>
                <div class="form-grid">
                    <div style="grid-column: span 2;"><label>Ä°lan BaÅŸlÄ±ÄŸÄ±</label><input type="text" id="title"></div>
                    <div><label>Fiyat</label><input type="text" id="price" oninput="formatCurr(this)"></div>
                    <div><label>Para Birimi</label><select id="currency"><option>TL</option><option>USD</option><option>EUR</option><option>GBP</option></select></div>
                    <div><label>Durum</label><select id="status"><option>SatÄ±lÄ±k</option><option>KiralÄ±k</option><option>Devren</option></select></div>
                    <div><label>Kategori</label><select id="type"></select></div> <div style="grid-column: span 3;"><label>AÃ§Ä±klama</label><textarea id="desc" rows="4"></textarea></div>
                    <div><label>Krediye Uygun?</label><select id="credit"><option>Evet</option><option>HayÄ±r</option></select></div>
                    <div><label>Takas?</label><select id="swap"><option>HayÄ±r</option><option>Evet</option></select></div>
                </div>
            </div>

            <div id="tab-teknik" class="tab-pane">
                <div class="form-grid">
                    <div><label>BrÃ¼t mÂ²</label><input type="number" id="gross"></div>
                    <div><label>Net mÂ²</label><input type="number" id="net"></div>
                    <div><label>Oda SayÄ±sÄ±</label><select id="rooms"></select></div> <div><label>Bina YaÅŸÄ±</label><input type="text" id="age"></div>
                    <div><label>BulunduÄŸu Kat</label><select id="floor"></select></div> <div><label>Kat SayÄ±sÄ±</label><input type="number" id="floorCount"></div>
                    <div><label>Banyo</label><input type="number" id="bath" value="1"></div>
                    <div><label>IsÄ±tma</label><select id="heating"><option>Klima</option><option>Kombi</option><option>Merkezi</option><option>Yerden IsÄ±tma</option><option>Soba</option><option>Yok</option></select></div>
                    <div><label>Tapu Durumu</label><select id="tapu"><option>Kat MÃ¼lkiyeti</option><option>Kat Ä°rtifakÄ±</option><option>Arsa PaylÄ±</option><option>MÃ¼stakil</option></select></div>
                    <div><label>Ada / Parsel</label><div style="display:flex; gap:5px;"><input type="text" id="ada" placeholder="Ada"><input type="text" id="parsel" placeholder="Parsel"></div></div>
                </div>
            </div>

            <div id="tab-konum" class="tab-pane">
                <div class="form-grid" style="margin-bottom:10px;">
                    <div><label>Ä°l</label><input type="text" id="city" value="Antalya"></div>
                    <div><label>Ä°lÃ§e</label><select id="district" onchange="loadNeigh()"></select></div>
                    <div><label>Mahalle</label><input type="text" list="dl_neigh" id="neighborhood"><datalist id="dl_neigh"></datalist></div>
                    <button class="btn btn-primary" onclick="getLoc()" style="margin-top:20px;">ğŸ“ KONUMU BUL</button>
                </div>
                <div id="mapCanvas"></div>
                <input type="hidden" id="lat"><input type="hidden" id="lng">
            </div>

            <div id="tab-ozellik" class="tab-pane">
                <h4>Cephe</h4>
                <div class="feature-grid">
                    <label class="feature-item"><input type="checkbox" class="feat" value="Kuzey"> Kuzey</label>
                    <label class="feature-item"><input type="checkbox" class="feat" value="GÃ¼ney"> GÃ¼ney</label>
                    <label class="feature-item"><input type="checkbox" class="feat" value="DoÄŸu"> DoÄŸu</label>
                    <label class="feature-item"><input type="checkbox" class="feat" value="BatÄ±"> BatÄ±</label>
                </div>
                <h4>Ä°Ã§ Ã–zellikler</h4>
                <div class="feature-grid">
                    <label class="feature-item"><input type="checkbox" class="feat" value="Ankastre"> Ankastre</label>
                    <label class="feature-item"><input type="checkbox" class="feat" value="Ebeveyn Banyosu"> Ebeveyn Banyosu</label>
                    <label class="feature-item"><input type="checkbox" class="feat" value="Giyinme OdasÄ±"> Giyinme OdasÄ±</label>
                    <label class="feature-item"><input type="checkbox" class="feat" value="Klima"> Klima</label>
                    <label class="feature-item"><input type="checkbox" class="feat" value="DuÅŸakabin"> DuÅŸakabin</label>
                    <label class="feature-item"><input type="checkbox" class="feat" value="Panjur"> Panjur</label>
                    <label class="feature-item"><input type="checkbox" class="feat" value="MobilyalÄ±"> MobilyalÄ±</label>
                </div>
                <h4>DÄ±ÅŸ & Site</h4>
                <div class="feature-grid">
                    <label class="feature-item"><input type="checkbox" class="feat" value="AsansÃ¶r"> AsansÃ¶r</label>
                    <label class="feature-item"><input type="checkbox" class="feat" value="Otopark"> Otopark</label>
                    <label class="feature-item"><input type="checkbox" class="feat" value="Havuz"> Havuz</label>
                    <label class="feature-item"><input type="checkbox" class="feat" value="GÃ¼venlik"> GÃ¼venlik</label>
                    <label class="feature-item"><input type="checkbox" class="feat" value="Ã‡ocuk ParkÄ±"> Ã‡ocuk ParkÄ±</label>
                </div>
            </div>

            <div id="tab-medya" class="tab-pane">
                <div style="text-align:center; padding:20px; border:2px dashed #ccc;">
                    <label>ğŸ“¸ Vitrin FotoÄŸrafÄ± YÃ¼kle</label><br><br>
                    <input type="file" id="photoIn" onchange="previewPhoto()" accept="image/*">
                    <br>
                    <img id="photoPreview" style="max-width:300px; display:none; margin-top:15px; border-radius:5px; border:1px solid #ddd;">
                    <input type="hidden" id="photoData">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-success" onclick="saveProRecord()">ğŸ’¾ KAYDET VE LÄ°STEYE EKLE</button>
            <button class="btn btn-primary" onclick="printReport(false)">ğŸ‘ï¸ MÃœÅTERÄ° RAPORU</button>
            <button class="btn btn-warning" onclick="printReport(true)">ğŸ”’ YÃ–NETÄ°CÄ° RAPORU</button>
        </div>
    </div>
</div>

<div id="printArea"></div>

<script>
    // --- VERÄ° TABANI (v27 GENÄ°Å LÄ°STELERÄ°) ---
    const antalyaData = {
        "Akseki": ["Merkez"], "Aksu": ["AltÄ±ntaÅŸ","Kundu","Macun","PÄ±narlÄ±"], 
        "Alanya": ["Merkez","Avsallar","Mahmutlar","Oba","Kestel"], 
        "DÃ¶ÅŸemealtÄ±": ["YenikÃ¶y","YeÅŸilbayÄ±r","AltÄ±nkale","BahÃ§eyaka"], 
        "Kepez": ["Varsak","KÃ¼ltÃ¼r","GÃ¼lveren","SÃ¼tÃ§Ã¼ler","AhatlÄ±"], 
        "KonyaaltÄ±": ["Liman","Hurma","UncalÄ±","GÃ¼rsu","Molla Yusuf"], 
        "MuratpaÅŸa": ["Lara","Fener","ÅirinyalÄ±","GÃ¼zeloba","KÄ±rcami","Meltem"], 
        "Serik": ["Belek","Kadriye","BoÄŸazkent"] 
    };
    const roomList = ["1+1","2+1","3+1","4+1","5+1","Villa","MÃ¼stakil","DÃ¼kkan"];
    const typeList = ["Daire","Villa","Arsa","Ä°ÅŸyeri","Turistik Tesis","Komple Bina","BahÃ§e"];
    const floorList = ["GiriÅŸ","1","2","3","4","5","6","7","8","9","10+","Ã‡atÄ± Dubleks","BahÃ§e Dubleks"];

    let portfolio = JSON.parse(localStorage.getItem('KaracabayRE_EST_DB_v19')) || [];
    let map = null, marker = null;

    // BAÅLANGIÃ‡
    window.onload = function() {
        populateLists();
        renderTable();
    };

    // --- HARÄ°TA FONKSÄ°YONLARI (Fix) ---
    function initMap() {
        if(map) return; 
        map = L.map('mapCanvas').setView([36.89, 30.71], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        map.on('click', function(e){
            if(marker) map.removeLayer(marker);
            marker = L.marker(e.latlng).addTo(map);
            document.getElementById('lat').value = e.latlng.lat;
            document.getElementById('lng').value = e.latlng.lng;
        });
    }

    // SEKME GEÃ‡Ä°ÅÄ° VE HARÄ°TA BOYUT DÃœZELTME
    function showTab(id) {
        document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        event.currentTarget.classList.add('active');
    }

    function fixMap() {
        setTimeout(() => { 
            if(!map) initMap(); 
            map.invalidateSize(); // BU SATIR HARÄ°TANIN GRÄ° Ã‡IKMASINI ENGELLER
        }, 300);
    }

    function getLoc() {
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(p => {
                if(!map) initMap();
                const lat = p.coords.latitude; const lng = p.coords.longitude;
                map.setView([lat, lng], 15);
                if(marker) map.removeLayer(marker);
                marker = L.marker([lat, lng]).addTo(map);
                document.getElementById('lat').value = lat;
                document.getElementById('lng').value = lng;
            });
        } else { alert("Konum alÄ±namadÄ±"); }
    }

    // --- VERÄ° YÃ–NETÄ°MÄ° ---
    function populateLists() {
        const dS = document.getElementById('district'), fD = document.getElementById('fDist');
        Object.keys(antalyaData).sort().forEach(d => {
            dS.innerHTML += `<option>${d}</option>`;
            fD.innerHTML += `<option>${d}</option>`;
        });
        const rS = document.getElementById('rooms'); roomList.forEach(r => rS.innerHTML += `<option>${r}</option>`);
        const tS = document.getElementById('type'), fT = document.getElementById('fType'); typeList.forEach(t => { tS.innerHTML += `<option>${t}</option>`; fT.innerHTML += `<option>${t}</option>`; });
        const fL = document.getElementById('floor'); floorList.forEach(f => fL.innerHTML += `<option>${f}</option>`);
    }

    function loadNeigh() {
        const dist = document.getElementById('district').value;
        const dl = document.getElementById('dl_neigh'); dl.innerHTML = '';
        if(antalyaData[dist]) antalyaData[dist].forEach(n => {
            let op = document.createElement('option'); op.value = n; dl.appendChild(op);
        });
    }

    function formatCurr(inp) { let v=inp.value.replace(/\D/g,''); inp.value=v.replace(/\B(?=(\d{3})+(?!\d))/g,"."); }
    function previewPhoto() {
        const f = document.getElementById('photoIn').files[0];
        if(f) {
            const r = new FileReader();
            r.onload = e => {
                document.getElementById('photoPreview').src = e.target.result;
                document.getElementById('photoPreview').style.display = 'block';
                document.getElementById('photoData').value = e.target.result;
            };
            r.readAsDataURL(f);
        }
    }

    // --- KAYIT Ä°ÅLEMLERÄ° (HEM v27 HEM v3.8 VERÄ°LERÄ°NÄ° TUTAR) ---
    function saveProRecord() {
        const id = document.getElementById('recId').value || 'ID' + Date.now();
        const rec = {
            id,
            // v3.8 DetaylarÄ±
            owner: document.getElementById('owner').value, ownerTel: document.getElementById('ownerTel').value,
            authStart: document.getElementById('authStart').value, authEnd: document.getElementById('authEnd').value,
            title: document.getElementById('title').value, desc: document.getElementById('desc').value,
            credit: document.getElementById('credit').value, swap: document.getElementById('swap').value,
            gross: document.getElementById('gross').value, net: document.getElementById('net').value,
            age: document.getElementById('age').value, floorCount: document.getElementById('floorCount').value,
            bath: document.getElementById('bath').value, heating: document.getElementById('heating').value,
            tapu: document.getElementById('tapu').value, ada: document.getElementById('ada').value, parsel: document.getElementById('parsel').value,
            lat: document.getElementById('lat').value, lng: document.getElementById('lng').value,
            photo: document.getElementById('photoData').value,
            features: [...document.querySelectorAll('.feat:checked')].map(c=>c.value),
            // v27 Ortak Alanlar (Listeleme Ä°Ã§in)
            price: document.getElementById('price').value, currency: document.getElementById('currency').value,
            status: document.getElementById('status').value, type: document.getElementById('type').value,
            district: document.getElementById('district').value, neighborhood: document.getElementById('neighborhood').value,
            rooms: document.getElementById('rooms').value, floor: document.getElementById('floor').value
        };

        if(!rec.district || !rec.price) { alert("Ä°lÃ§e ve Fiyat zorunludur!"); return; }

        const idx = portfolio.findIndex(p => p.id === id);
        if(idx > -1) portfolio[idx] = rec; else portfolio.push(rec);
        
        localStorage.setItem('KaracabayRE_EST_DB_v19', JSON.stringify(portfolio));
        alert('Kaydedildi! âœ…');
        closeProModal();
        renderTable();
    }

    function renderTable() {
        const tbody = document.getElementById('listBody'); tbody.innerHTML = '';
        const term = document.getElementById('search').value.toLowerCase();
        const fT = document.getElementById('fType').value;
        const fD = document.getElementById('fDist').value;

        portfolio.forEach(p => {
            const txt = (p.title + p.district + p.neighborhood + p.owner).toLowerCase();
            if(!txt.includes(term)) return;
            if(fT !== 'all' && p.type !== fT) return;
            if(fD !== 'all' && p.district !== fD) return;

            let badge = p.status === 'SatÄ±lÄ±k' ? 'satilik' : (p.status === 'KiralÄ±k' ? 'kiralik' : 'satildi');
            
            tbody.innerHTML += `
            <tr>
                <td><span class="badge ${badge}">${p.status}</span><br><small>${p.type}</small></td>
                <td><b>${p.district}</b><br><small>${p.neighborhood}</small></td>
                <td>${p.rooms}<br>${p.gross} mÂ²</td>
                <td style="font-weight:bold; color:#27ae60;">${p.price} ${p.currency}</td>
                <td>
                    <button class="btn btn-primary" onclick="editRec('${p.id}')">DÃœZENLE / GÃ–R</button>
                    <button class="btn btn-danger" onclick="delRec('${p.id}')">SÄ°L</button>
                </td>
            </tr>`;
        });
    }

    function editRec(id) {
        const p = portfolio.find(x => x.id === id);
        if(!p) return;
        document.getElementById('recId').value = p.id;
        // TÃ¼m alanlarÄ± doldur
        document.getElementById('owner').value = p.owner || ''; document.getElementById('ownerTel').value = p.ownerTel || '';
        document.getElementById('title').value = p.title || ''; document.getElementById('price').value = p.price || '';
        document.getElementById('district').value = p.district || ''; loadNeigh(); document.getElementById('neighborhood').value = p.neighborhood || '';
        document.getElementById('desc').value = p.desc || '';
        // FotoÄŸraf
        if(p.photo) { document.getElementById('photoPreview').src = p.photo; document.getElementById('photoPreview').style.display = 'block'; document.getElementById('photoData').value = p.photo; }
        // Ã–zellik CheckboxlarÄ±
        document.querySelectorAll('.feat').forEach(c => c.checked = false);
        if(p.features) p.features.forEach(v => { let el = document.querySelector(`.feat[value="${v}"]`); if(el) el.checked=true; });
        
        openProModal();
    }

    function delRec(id) { if(confirm('Silinecek?')) { portfolio = portfolio.filter(p => p.id !== id); localStorage.setItem('KaracabayRE_EST_DB_v19', JSON.stringify(portfolio)); renderTable(); } }

    function openProModal() { document.getElementById('proModal').style.display = 'block'; showTab('tab-kimlik'); }
    function closeProModal() { document.getElementById('proModal').style.display = 'none'; document.getElementById('recId').value = ''; document.querySelectorAll('input').forEach(i => i.value=''); }

    // --- RAPORLAMA (PRINT) ---
    function printReport(isAdmin) {
        const id = document.getElementById('recId').value;
        const p = portfolio.find(x => x.id === id);
        if(!p) { alert("Ã–nce kaydedin!"); return; }

        let adminHtml = isAdmin ? `<div style="background:#fff3cd; padding:15px; border:2px dashed orange; margin-bottom:20px;"><b>ğŸ”’ YÃ–NETÄ°CÄ° BÄ°LGÄ°SÄ°:</b><br>Mal Sahibi: ${p.owner} | Tel: ${p.ownerTel}<br>Yetki: ${p.authStart} - ${p.authEnd}</div>` : '';
        let featHtml = p.features ? p.features.map(f => `<span style="border:1px solid #ccc; padding:3px 8px; margin:3px; display:inline-block; border-radius:4px;">${f}</span>`).join(' ') : '';
        let imgHtml = p.photo ? `<img src="${p.photo}" style="max-width:100%; border-radius:8px; margin-bottom:15px;">` : '';

        const html = `
            <div style="font-family:sans-serif; padding:20px;">
                ${adminHtml}
                <div class="print-flex">
                    <div class="print-col">
                        ${imgHtml}
                    </div>
                    <div class="print-col">
                        <div class="doc-title">${p.title || 'Ä°lan BaÅŸlÄ±ÄŸÄ± Yok'}</div>
                        <div class="doc-price">${p.price} ${p.currency}</div>
                        <table class="doc-table">
                            <tr><td class="doc-label">Konum:</td><td>${p.district} / ${p.neighborhood}</td></tr>
                            <tr><td class="doc-label">Tip / Oda:</td><td>${p.type} / ${p.rooms}</td></tr>
                            <tr><td class="doc-label">Metrekare:</td><td>${p.gross} mÂ² (BrÃ¼t) / ${p.net} mÂ² (Net)</td></tr>
                            <tr><td class="doc-label">Kat:</td><td>${p.floor} (Top: ${p.floorCount})</td></tr>
                            <tr><td class="doc-label">IsÄ±tma:</td><td>${p.heating}</td></tr>
                        </table>
                    </div>
                </div>
                <hr>
                <h3>AÃ§Ä±klama</h3>
                <p style="white-space:pre-wrap;">${p.desc}</p>
                <h3>Ã–zellikler</h3>
                <div>${featHtml}</div>
            </div>
        `;
        document.getElementById('printArea').innerHTML = html;
        window.print();
    }
    
    // --- YEDEKLEME ---
    function exportData(){ let b = new Blob([JSON.stringify(portfolio)],{type:'application/json'}); let a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='yedek.json'; a.click(); }
    function importData(inp){ let r=new FileReader(); r.onload=e=>{portfolio=JSON.parse(e.target.result); localStorage.setItem('KaracabayRE_EST_DB_v19', JSON.stringify(portfolio)); location.reload();}; r.readAsText(inp.files[0]); }
</script>
</body>
</html>
