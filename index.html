<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="KARACABAYRE.EST - KiÅŸisel Emlak YÃ¶netim Paneli">
    <meta name="robots" content="noindex, nofollow, noarchive">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KARACABAYRE.EST - v27 + v3.8 Entegre</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- v27 ORÄ°JÄ°NAL CSS --- */
        :root { --primary: #2c3e50; --secondary: #3498db; --accent: #27ae60; --danger: #c0392b; --sold: #d63031; --tool-bg: #f8f9fa; --warning-bg: #fff3cd; --alert-bg: #f8d7da; }
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f3; margin: 0; padding: 20px; color: #333; }
        body.no-scroll { overflow: hidden; } 
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .login-box { background: white; padding: 30px; border-radius: 10px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 300px; }
        .login-box h2 { color: #333; margin-top: 0; }
        .login-box input { width: 80%; padding: 10px; margin: 15px 0; font-size: 18px; text-align: center; border: 2px solid #ddd; border-radius: 5px; }
        .login-box button { width: 90%; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; }
        #appContainer { display: none; }
        .container { max-width: 1800px; margin: 0 auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .backup-controls { display: flex; gap: 10px; }
        .btn-backup { background: #f39c12; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; display: flex; align-items: center; gap: 5px; }
        .tools-bar { display: flex; gap: 10px; background: var(--tool-bg); padding: 10px; border-radius: 6px; margin-bottom: 25px; border: 1px solid #ddd; flex-wrap: wrap; align-items: center; }
        .tool-btn { background: white; border: 1px solid #ccc; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 8px; transition: all 0.2s; text-decoration: none; }
        .tool-btn:hover { background: var(--secondary); color: white; border-color: var(--secondary); }
        .dakv-btn { background: #fef9e7; color: #d35400; border-color: #f39c12; } .dakv-btn:hover { background: #d35400; color: white; }
        .crm-btn { background: #ebf5fb; color: #2980b9; border-color: #2980b9; } .crm-btn:hover { background: #2980b9; color: white; }
        .input-panel { background: #fdfdfd; padding: 20px; border: 1px solid #ddd; border-left: 6px solid var(--primary); margin-bottom: 30px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; }
        .form-group label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 5px; color: #555; text-transform: uppercase; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        textarea.auto-expand { overflow-y: hidden; min-height: 40px; resize: none; transition: height 0.1s; }
        .currency-group { display: flex; gap: 5px; }
        .currency-group select { width: 70px; flex-shrink: 0; background: #eee; font-weight: bold; }
        .auth-box { grid-column: span 2; display: flex; gap: 15px; background: #eafaf1; padding: 15px; border: 1px dashed var(--accent); border-radius: 6px; }
        .form-buttons { grid-column: span 2; display: flex; gap: 10px; margin-top: 10px; }
        .btn-save { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 2; }
        .btn-save:hover { background: #219150; }
        .btn-delete-rec { background: var(--danger); color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; display: none; }
        .btn-cancel { background: #7f8c8d; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; table-layout: fixed; }
        th { background: #34495e; color: white; padding: 12px; text-align: left; vertical-align: middle; }
        td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; word-wrap: break-word; }
        tr:hover { background: #f9f9f9; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 11px; font-weight: bold; display:inline-block; }
        .satilik { background: var(--secondary); } .kiralik { background: #e67e22; } .kirmizi-etiket { background: var(--sold) !important; }
        .direct-link-btn { display: inline-block; background-color: #3498db; color: white; text-decoration: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; font-weight: 600; }
        .link-sahibinden { background-color: #f1c40f; color: black; } .link-hepsi { background-color: #e74c3c; } .link-obudur { background-color: #8e44ad; } .link-emlakjet { background-color: #2ecc71; } .link-dosya { background-color: #95a5a6; border: 1px solid #7f8c8d; } .link-sosyal { background-color: #d63031; }
        .filter-bar { background: var(--primary); padding: 15px; border-radius: 6px; display: flex; gap: 10px; flex-wrap: wrap; color: white; align-items: center; }
        .filter-bar input, .filter-bar select { padding: 8px; border: none; border-radius: 4px; color: #333; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; overflow-y: hidden; }
        .modal-content { background: white; margin: 3% auto; padding: 25px; width: 90%; border-radius: 8px; position: relative; max-height: 85vh; display: flex; flex-direction: column; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .modal-body { overflow-y: auto; margin-top: 15px; padding-right: 10px; }
        .tool-modal-content { width: 450px; margin: 10% auto; }
        .crm-header { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px; flex-shrink: 0; }
        .crm-tab { padding: 10px 20px; cursor: pointer; font-weight: bold; border-radius: 6px; border: 1px solid #eee; background: #f9f9f9; }
        .crm-tab.active { background: var(--secondary); color: white; border-color: var(--secondary); }
        .crm-input-panel { background: #f1f2f6; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 5px solid var(--secondary); flex-shrink: 0; }
        .crm-input-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; align-items: start; }
        .crm-buttons { display: flex; gap: 10px; margin-top: 15px; justify-content: flex-end; }
        .table-scroll-wrapper { height: 50vh; overflow-y: auto; border: 1px solid #eee; border-radius: 4px; overscroll-behavior: contain; -webkit-overflow-scrolling: touch; background-color: white; }
        .crm-table { width: 100%; border-collapse: collapse; background-color: white; }
        .crm-table tr { background-color: white; }
        .crm-table tr:hover { background-color: #f9f9f9; }
        .crm-table thead th { position: sticky; top: 0; z-index: 1; box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1); background-color: #34495e; color: white; }
        .row-alert { background-color: var(--alert-bg) !important; color: #721c24; }
        .row-warning { background-color: var(--warning-bg) !important; color: #856404; }
        .crm-status-badge { padding: 3px 6px; border-radius: 4px; font-weight: bold; font-size: 11px; }
        .calc-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .calc-btn { padding: 15px; font-size: 18px; cursor: pointer; background: #eee; border: none; border-radius: 4px; } .calc-btn:hover { background: #ddd; }
        .calc-btn.op { background: var(--secondary); color: white; } .calc-btn.eq { background: var(--accent); color: white; grid-column: span 2; }
        .calc-screen { width: 100%; padding: 10px; font-size: 24px; text-align: right; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
        .currency-board { display: flex; flex-direction: column; gap: 15px; }
        .currency-row { display: flex; align-items: center; justify-content: space-between; background: #f9f9f9; padding: 10px; border-radius: 6px; border: 1px solid #eee; }
        .result-box { margin-top: 15px; padding: 10px; background: #f0f9ff; border: 1px solid #bce8f1; color: #31708f; font-weight: bold; border-radius: 4px; text-align: center; font-size: 1.1em; }
        .tab-buttons { display: flex; border-bottom: 1px solid #ddd; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 10px; border: none; background: none; cursor: pointer; border-bottom: 3px solid transparent; }
        .tab-btn.active { border-bottom-color: var(--secondary); color: var(--secondary); font-weight: bold; }
        .tab-content { display: none; } .tab-content.active { display: block; }
        .legal-footer { margin-top: 30px; text-align: center; color: #95a5a6; font-size: 11px; border-top: 1px solid #eee; padding-top: 10px; }
        .print-only { display: none; }

        /* IFRAME OVERLAY STÄ°LLERÄ° (v3.8 Ä°Ã‡Ä°N) */
        #crmV38Overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100000;
        }
        #crmFrame {
            width: 100%; height: 100%; border: none;
        }
        .close-overlay-btn {
            position: absolute; top: 10px; right: 20px; z-index: 100001;
            background: #c0392b; color: white; border: none; padding: 10px 20px;
            font-weight: bold; cursor: pointer; border-radius: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        @media print { 
            .input-panel, .filter-bar, .backup-controls, .tools-bar, .legal-footer, #loginOverlay { display: none !important; } 
            .no-print { display: none !important; }
            .print-only { display: table-cell !important; }
            #appContainer { display: block !important; }
            body { background: white; padding: 0; margin: 0; }
            table { width: 100%; font-size: 10px; }
            th, td { border: 1px solid #ddd; padding: 4px; color: black; }
        }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2>ğŸ”’ GÃœVENLÄ° GÄ°RÄ°Å</h2>
        <p>KaracabayRE.EST Sistemine EriÅŸmek Ä°Ã§in Åifre Giriniz</p>
        <input type="password" id="loginPin" placeholder="Åifre (1923)" inputmode="numeric">
        <button onclick="checkLogin()">GÄ°RÄ°Å YAP</button>
        <div style="margin-top:15px; font-size:11px; color:#777;">KiÅŸisel KullanÄ±m Ä°Ã§indir.</div>
    </div>
</div>

<div id="appContainer">
    <div class="container">
        <header>
            <div>
                <h1>ğŸ¢ KARACABAYRE.EST <span style="font-size:12px; color:#27ae60; border:1px solid #27ae60; padding:2px 8px; border-radius:10px;">HDD KAYIT AKTÄ°F</span></h1>
            </div>
            <div class="backup-controls">
                <input type="file" id="fileUpload" style="display:none;" onchange="uploadData(this)">
                <button class="btn-backup btn-upload" onclick="document.getElementById('fileUpload').click()">ğŸ“‚ YEDEK YÃœKLE</button>
                <button class="btn-backup" onclick="downloadData()">ğŸ’¾ YEDEKLE</button>
            </div>
        </header>

        <div class="tools-bar">
            <button class="tool-btn" style="background:#eafaf1; border-color:#27ae60; color:#27ae60;" onclick="openCrmV38()"><i class="fa-solid fa-layer-group"></i> <b>ğŸ› ï¸ DETAYLI CRM (v3.8)</b></button>
            
            <button class="tool-btn crm-btn" onclick="openCRM()"><i class="fa-solid fa-users"></i> MÃ¼ÅŸteri Ä°liÅŸkileri (CRM)</button>
            <button class="tool-btn" onclick="openModal('calcModal')"><i class="fa-solid fa-calculator"></i> Hesap Makinesi</button>
            <button class="tool-btn" onclick="openModal('currencyModal'); fetchCurrency();"><i class="fa-solid fa-money-bill-transfer"></i> DÃ¶viz Ã‡evirici</button>
            <button class="tool-btn" onclick="openModal('realEstateCalcModal')"><i class="fa-solid fa-file-contract"></i> Hesaplamalar</button>
            <a href="https://www.hesapkurdu.com/konut-kredisi/h/gayrimenkul-deger-artis-kazanci-vergisi-hesaplama" target="_blank" class="tool-btn dakv-btn"><i class="fa-solid fa-calculator"></i> DAKV Hesapla</a>
            <a href="https://parselsorgu.tkgm.gov.tr/" target="_blank" class="tool-btn tkgm-btn"><i class="fa-solid fa-map-location-dot"></i> TKGM Parsel Sorgu</a>
        </div>

        <div class="input-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <span id="formTitle" style="font-weight:bold; color:var(--primary); font-size:1.1em;">â• Yeni PortfÃ¶y Ekle</span>
                <button id="btnCancel" class="btn-cancel" onclick="resetForm()">TEMÄ°ZLE / Ä°PTAL</button>
            </div>
            <div class="form-grid">
                <div class="form-group"><label>Menkul Cinsi</label><select id="inpType"></select></div>
                <div class="form-group"><label>Ä°ÅŸlem TÃ¼rÃ¼</label><select id="inpStatus"><option>SatÄ±lÄ±k</option><option>KiralÄ±k</option><option>Devren</option><option style="color:red; font-weight:bold;">SatÄ±ldÄ±</option><option style="color:red; font-weight:bold;">KiralandÄ±</option></select></div>
                <div class="form-group"><label>Ä°lÃ§e</label><select id="inpDistrict" onchange="loadMahalleler('inpDistrict', 'dl_mahalle_ekle')"><option value="">SeÃ§iniz</option></select></div>
                <div class="form-group"><label>Mahalle</label><input type="text" list="dl_mahalle_ekle" id="inpNeighborhood" placeholder="YazÄ±nÄ±z..." autocomplete="off"><datalist id="dl_mahalle_ekle"></datalist></div>
                <div class="form-group"><label>Oda SayÄ±sÄ±</label><select id="inpRooms"></select></div>
                
                <div class="form-group"><label>BulunduÄŸu Kat</label><select id="inpFloor"></select></div>
                <div class="form-group"><label>Bina Kat SayÄ±sÄ±</label><input type="number" id="inpFloorCount" placeholder="Manuel GiriÅŸ"></div>

                <div class="form-group"><label>BrÃ¼t mÂ²</label><input type="number" id="inpGross" placeholder="mÂ²"></div>
                <div class="form-group"><label>Net mÂ²</label><input type="number" id="inpNet" placeholder="mÂ²"></div>
                
                <div class="form-group"><label>Fiyat</label>
                    <div class="currency-group">
                        <input type="text" id="inpPrice" placeholder="5.000.000" oninput="formatCurrency(this)">
                        <select id="inpCurrency">
                            <option value="â‚º">TL</option>
                            <option value="$">USD</option>
                            <option value="â‚¬">EUR</option>
                            <option value="Â£">GBP</option>
                        </select>
                    </div>
                </div>

                <div class="auth-box">
                    <div class="form-group" style="flex:1;"><label>Yetki BaÅŸlangÄ±Ã§</label><input type="date" id="inpAuthStart"></div>
                    <div class="form-group" style="flex:1;"><label>Yetki BitiÅŸ</label><input type="date" id="inpAuthEnd"></div>
                </div>
                <div class="form-group"><label>MÃ¼ÅŸteri Ad Soyad</label><input type="text" id="inpRef"></div>
                <div class="form-group"><label>MÃ¼ÅŸteri Telefon</label><input type="text" id="inpPhone" placeholder="0 (5XX) XXX XX XX" maxlength="17" oninput="formatPhone(this)"></div>
                <div class="form-group"><label>Dosya / Link</label><textarea id="inpLink" placeholder="Link veya Dosya Yolu..." rows="1" class="auto-expand" oninput="autoResize(this)"></textarea></div>
                <div class="form-group" style="grid-column:span 2;"><label>AÃ§Ä±klama</label><textarea id="inpDesc" class="auto-expand" placeholder="DetaylÄ± aÃ§Ä±klama..." oninput="autoResize(this)"></textarea></div>
                <div class="form-buttons">
                    <button id="btnSave" class="btn-save" onclick="handleSave()">KAYDET</button>
                    <button id="btnDelete" class="btn-delete-rec" onclick="deleteFromForm()">ğŸ—‘ï¸ SÄ°L</button>
                </div>
            </div>
        </div>

        <div class="filter-bar">
            <span>ğŸ” ARA:</span> <input type="text" id="searchBox" placeholder="Ä°sim, Tel, Not..." onkeyup="renderTable()" style="width:140px;">
            <select id="filterType" onchange="renderTable()" style="width:130px;"><option value="all">TÃ¼m Menkuller</option></select>
            <select id="filterStatus" onchange="renderTable()" style="width:110px;"><option value="all">TÃ¼m Durumlar</option><option>SatÄ±lÄ±k</option><option>KiralÄ±k</option><option>Devren</option><option style="color:red;">SatÄ±ldÄ±</option><option style="color:red;">KiralandÄ±</option></select>
            <select id="filterRooms" onchange="renderTable()" style="width:100px;"><option value="all">TÃ¼m Odalar</option></select>
            <select id="filterDistrict" onchange="loadMahalleler('filterDistrict', 'dl_mahalle_filtre')"><option value="all">TÃ¼m Ä°lÃ§eler</option></select>
            <input type="text" list="dl_mahalle_filtre" id="filterNeighborhood" placeholder="Mahalle Ara..." onkeyup="renderTable()" style="width:120px;" autocomplete="off"><datalist id="dl_mahalle_filtre"></datalist>
            <input type="text" id="filterMinPrice" placeholder="Min Fiyat" oninput="formatCurrency(this); renderTable()" style="width:90px;"> 
            <input type="text" id="filterMaxPrice" placeholder="Max Fiyat" oninput="formatCurrency(this); renderTable()" style="width:90px;">
            <button onclick="window.print()" style="margin-left:auto; background:#8e44ad; border:none; color:white; padding:8px 15px; border-radius:4px; cursor:pointer;">ğŸ–¨ï¸ YAZDIR</button>
        </div>
        <table id="portfolioTable"><thead><tr><th width="8%">Cins/TÃ¼r</th><th width="12%">Lokasyon</th><th width="8%">Ã–zellikler</th><th width="10%">mÂ² (BrÃ¼t/Net)</th><th width="11%">Fiyat</th><th width="14%">MÃ¼ÅŸteri / Tel</th><th width="9%">Yetki</th><th class="no-print" width="6%" style="text-align:center;">Linkler</th><th class="no-print" width="5%" style="text-align:center;">Not</th><th class="no-print" width="8%">Ä°ÅŸlem</th><th class="print-only">AÃ§Ä±klama / Notlar</th></tr></thead><tbody id="tableBody"></tbody></table>
        <div class="legal-footer">Veriler yerel tarayÄ±cÄ±da saklanÄ±r. (v27 + v3.8 Hybrid)</div>
    </div>
</div>

<div id="crmModal" class="modal" onclick="closeModalOutside(event, 'crmModal')">
    <div class="modal-content">
        <div style="display:flex;justify-content:space-between; margin-bottom:10px;"><h3>ğŸ‘¥ MÃ¼ÅŸteri Ä°liÅŸkileri (CRM)</h3><span onclick="closeModal('crmModal')" style="cursor:pointer;font-size:24px;">&times;</span></div>
        <div class="crm-header">
            <div id="tab1" class="crm-tab active" onclick="switchCRMTab('investors')">ğŸ’° Talep Havuzu</div>
            <div id="tab2" class="crm-tab" onclick="switchCRMTab('network')">ğŸ“¢ Etki Ã‡evresi</div>
        </div>
        <div id="crmInvestors" class="crm-section" style="display:block;">
            <div class="crm-input-panel">
                <div class="crm-input-grid">
                    <div class="form-group"><label>Ad Soyad</label><input type="text" id="invName"></div>
                    <div class="form-group"><label>Åehir</label><input type="text" id="invCity" value="Antalya"></div>
                    <div class="form-group"><label>Telefon (Alt alta Ã§oklu)</label><textarea id="invPhone" rows="2" class="auto-expand" placeholder="0 (5XX) XXX XX XX" oninput="formatPhoneMulti(this)"></textarea></div>
                    <div class="form-group"><label>Talep</label><textarea id="invRequest" rows="2" class="auto-expand" placeholder="Detaylar..."></textarea></div>
                </div>
                <div class="crm-buttons">
                    <button id="btnInvSave" class="btn-save" style="flex:0; width:120px;" onclick="saveCRMInvestor()">EKLE</button>
                    <button id="btnInvDelete" class="btn-delete-rec" style="flex:0; width:100px; display:none;" onclick="deleteCRMInvestor()">SÄ°L</button>
                    <button id="btnInvCancel" class="btn-cancel" style="flex:0; display:none;" onclick="resetCRMForm('investors')">Ä°PTAL</button>
                </div>
            </div>
            <div class="table-scroll-wrapper"><table class="crm-table"><thead><tr><th>Ad Soyad</th><th>Åehir</th><th>Telefon</th><th>Talep DetayÄ±</th><th width="80">Ä°ÅŸlem</th></tr></thead><tbody id="investorTableBody"></tbody></table></div>
        </div>
        <div id="crmNetwork" class="crm-section" style="display:none;">
            <div class="crm-input-panel">
                <div class="crm-input-grid">
                    <div class="form-group"><label>Ad Soyad</label><input type="text" id="netName"></div>
                    <div class="form-group"><label>Åehir</label><input type="text" id="netCity" value="Antalya"></div>
                    <div class="form-group"><label>Telefon (Alt alta Ã§oklu)</label><textarea id="netPhone" rows="2" class="auto-expand" placeholder="0 (5XX) XXX XX XX" oninput="formatPhoneMulti(this)"></textarea></div>
                    <div class="form-group"><label>Arz TÃ¼rÃ¼ / Potansiyel</label><textarea id="netSupply" rows="2" class="auto-expand" placeholder="Ã–rn: Site YÃ¶neticisi"></textarea></div>
                    <div class="form-group"><label>Son Arama</label><input type="date" id="netLastCall"></div>
                </div>
                <div class="crm-buttons">
                    <button id="btnNetSave" class="btn-save" style="flex:0; width:120px;" onclick="saveCRMNetwork()">EKLE</button>
                    <button id="btnNetDelete" class="btn-delete-rec" style="flex:0; width:100px; display:none;" onclick="deleteCRMNetwork()">SÄ°L</button>
                    <button id="btnNetCancel" class="btn-cancel" style="flex:0; display:none;" onclick="resetCRMForm('network')">Ä°PTAL</button>
                </div>
            </div>
            <div class="table-scroll-wrapper"><table class="crm-table"><thead><tr><th>Durum</th><th>Ad Soyad</th><th>Åehir</th><th>Telefon</th><th>Arz / Potansiyel</th><th>Son Arama</th><th width="120">Takip</th><th width="80">Ä°ÅŸlem</th></tr></thead><tbody id="networkTableBody"></tbody></table></div>
        </div>
    </div>
</div>

<div id="descModal" class="modal" onclick="closeModalOutside(event, 'descModal')"><div class="modal-content"><div style="display:flex;justify-content:space-between;"><h3>ğŸ“ Notlar</h3><span onclick="closeModal('descModal')" style="cursor:pointer;">&times;</span></div><p id="modalText" style="white-space: pre-wrap; margin-top:10px;"></p></div></div>
<div id="calcModal" class="modal" onclick="closeModalOutside(event, 'calcModal')"><div class="modal-content tool-modal-content"><div style="display:flex;justify-content:space-between;margin-bottom:10px;"><h3>ğŸ§® Hesap Makinesi</h3><span onclick="closeModal('calcModal')" style="cursor:pointer;font-size:24px;">&times;</span></div><input type="text" id="calcDisplay" class="calc-screen" readonly><div class="calc-grid"><button class="calc-btn" onclick="calcInput('7')">7</button><button class="calc-btn" onclick="calcInput('8')">8</button><button class="calc-btn" onclick="calcInput('9')">9</button><button class="calc-btn op" onclick="calcInput('/')">Ã·</button><button class="calc-btn" onclick="calcInput('4')">4</button><button class="calc-btn" onclick="calcInput('5')">5</button><button class="calc-btn" onclick="calcInput('6')">6</button><button class="calc-btn op" onclick="calcInput('*')">Ã—</button><button class="calc-btn" onclick="calcInput('1')">1</button><button class="calc-btn" onclick="calcInput('2')">2</button><button class="calc-btn" onclick="calcInput('3')">3</button><button class="calc-btn op" onclick="calcInput('-')">-</button><button class="calc-btn" onclick="calcInput('0')">0</button><button class="calc-btn" onclick="calcInput('.')">.</button><button class="calc-btn" onclick="calcClear()">C</button><button class="calc-btn op" onclick="calcInput('+')">+</button><button class="calc-btn eq" onclick="calcResult()">=</button></div></div></div>
<div id="currencyModal" class="modal" onclick="closeModalOutside(event, 'currencyModal')"><div class="modal-content tool-modal-content"><div style="display:flex;justify-content:space-between; margin-bottom:15px;"><h3>ğŸ’± DÃ¶viz</h3><span onclick="closeModal('currencyModal')" style="cursor:pointer;font-size:24px;">&times;</span></div><div class="currency-board"><div class="currency-row"><span class="curr-flag">ğŸ‡ºğŸ‡¸</span><span class="curr-name">USD / TRY</span><div><input type="number" id="usdRate" class="curr-input" placeholder="36.00"></div></div><div class="currency-row"><span class="curr-flag">ğŸ‡ªğŸ‡º</span><span class="curr-name">EUR / TRY</span><div><input type="number" id="eurRate" class="curr-input" placeholder="38.00"></div></div></div><hr><div class="form-group"><div style="display:flex; gap:10px;"><input type="number" id="calcCurrAmount" placeholder="1000" style="flex:2;"><select id="calcCurrType" style="flex:1;"><option value="USD">USD</option><option value="EUR">EUR</option></select></div></div><button class="btn-save" style="width:100%; margin-top:10px;" onclick="calculateCurrencyTotal()">HESAPLA (TL)</button><div id="currencyTotalRes" class="currency-result" style="display:none;"><span id="currResText" style="font-size:1.4em; font-weight:bold; color:#2c3e50;">0,00 TL</span></div></div></div>
<div id="realEstateCalcModal" class="modal" onclick="closeModalOutside(event, 'realEstateCalcModal')"><div class="modal-content" style="width:500px;"><div style="display:flex;justify-content:space-between; margin-bottom:10px;"><h3>ğŸ§¾ Emlak HesaplamalarÄ±</h3><span onclick="closeModal('realEstateCalcModal')" style="cursor:pointer;font-size:24px;">&times;</span></div><div class="tab-buttons"><button class="tab-btn active" onclick="switchTab('tabTapu')">Tapu & Komisyon</button><button class="tab-btn" onclick="switchTab('tabEmsal')">Emsal</button><button class="tab-btn" onclick="switchTab('tabVergi')">Emlak Vergisi</button></div><div id="tabTapu" class="tab-content active"><div class="form-group"><label>SatÄ±ÅŸ Bedeli</label><input type="number" id="calcPrice" placeholder="5000000"></div><button class="btn-save" style="width:100%;" onclick="calcTapuKomisyon()">HESAPLA</button><div id="resTapu" class="result-box" style="display:none;"></div></div><div id="tabEmsal" class="tab-content"><div class="form-group"><label>Arsa AlanÄ±</label><input type="number" id="calcArsaM2"></div><div class="form-group"><label>Emsal</label><input type="number" id="calcKaks"></div><button class="btn-save" style="width:100%;" onclick="calcEmsal()">HESAPLA</button><div id="resEmsal" class="result-box" style="display:none;"></div></div><div id="tabVergi" class="tab-content"><div class="form-group"><label>Vergi</label><select id="calcVergiType"><option value="0.002">Konut (B.Åehir)</option></select><input type="number" id="calcVergiDeger" placeholder="RayiÃ§"></div><button class="btn-save" style="width:100%;" onclick="calcEmlakVergisi()">HESAPLA</button><div id="resVergi" class="result-box" style="display:none;"></div></div></div></div>

<div id="crmV38Overlay">
    <button class="close-overlay-btn" onclick="closeCrmV38()">âŒ KAPAT VE v27'YE DÃ–N</button>
    <iframe id="crmFrame"></iframe>
</div>

<script>
    // --- LOGIN ---
    function checkLogin() { if(document.getElementById('loginPin').value==="1923"){document.getElementById('loginOverlay').style.display='none';document.getElementById('appContainer').style.display='block';window.scrollTo(0,0);}else{alert("HatalÄ± Åifre!");} }

    // --- v27 DATA ---
    const antalyaData = { "Akseki": ["Merkez"], "Aksu": ["AltÄ±ntaÅŸ","Kundu","Macun","PÄ±narlÄ±"], "Alanya": ["Merkez","Avsallar","Mahmutlar"], "DÃ¶ÅŸemealtÄ±": ["YenikÃ¶y","YeÅŸilbayÄ±r","AltÄ±nkale"], "Kepez": ["Varsak","KÃ¼ltÃ¼r","SÃ¼tÃ§Ã¼ler"], "KonyaaltÄ±": ["Liman","Hurma","UncalÄ±"], "MuratpaÅŸa": ["Lara","Fener","ÅirinyalÄ±"], "Serik": ["Belek","Kadriye"] };
    const floorList = ["GiriÅŸ AltÄ± (Kot 1)","GiriÅŸ AltÄ± (Kot 2)","Bodrum Kat","Zemin Kat","GiriÅŸ KatÄ±","YÃ¼ksek GiriÅŸ","1. Kat","2. Kat","3. Kat","4. Kat","5. Kat","6. Kat","7. Kat","8. Kat","9. Kat","10. Kat","11. Kat","12. Kat","13. Kat","14. Kat","15. Kat","16. Kat","17. Kat","18. Kat","19. Kat","20. Kat","En Ãœst Kat","Ã‡atÄ± KatÄ±","BahÃ§e Dubleksi","Ã‡atÄ± Dubleksi","Ters Dubleks","GiriÅŸ Dubleks","Villa Tipi","MÃ¼stakil","Komple Bina"];
    const roomList = ["StÃ¼dyo (1+0)","1+1","1.5+1","2+0","2+1","2.5+1","3+1","3.5+1","4+1","4+2","5+1","5+2","6+1","6+2","7+1","8+1","9+1","10 Ãœzeri"];
    const typeList = ["Daire","Residence","Villa","MÃ¼stakil Ev","YazlÄ±k","Prefabrik","KÃ¶ÅŸk/Konak","YalÄ±","Ã‡iftlik Evi","Kooperatif","Arsa","Tarla","BahÃ§e","Zeytinlik","Ä°ÅŸyeri","DÃ¼kkan","MaÄŸaza","Ofis/BÃ¼ro","Depo/Antrepo","Fabrika","AtÃ¶lye","Ä°malathane","Plaza KatÄ±","Komple Bina","Otel/Pansiyon","DevremÃ¼lk","Turistik Tesis"];

    let crmData = JSON.parse(localStorage.getItem('KaracabayRE_CRM_v19')) || { investors: [], network: [] };
    let portfolio = JSON.parse(localStorage.getItem('KaracabayRE_EST_DB_v19')) || [];
    let editingId = null; let crmEditingId = null;

    window.onload = function() { populateSelects(); renderTable(); };

    // --- v27 FUNCTIONS ---
    function populateSelects() { 
        const dS=document.getElementById('inpDistrict'), fS=document.getElementById('filterDistrict'); 
        Object.keys(antalyaData).sort().forEach(d=>{dS.innerHTML+=`<option>${d}</option>`;fS.innerHTML+=`<option>${d}</option>`;}); 
        const rS=document.getElementById('inpRooms'), rF=document.getElementById('filterRooms'); 
        roomList.forEach(r=>{rS.innerHTML+=`<option>${r}</option>`;rF.innerHTML+=`<option>${r}</option>`;}); 
        const tS=document.getElementById('inpType'), tF=document.getElementById('filterType'); 
        typeList.forEach(t=>{tS.innerHTML+=`<option>${t}</option>`;tF.innerHTML+=`<option>${t}</option>`;});
        const fL=document.getElementById('inpFloor'); floorList.forEach(f=>fL.innerHTML+=`<option>${f}</option>`); 
    }
    function loadMahalleler(s,t) { const v=document.getElementById(s).value, d=document.getElementById(t); d.innerHTML=''; if(antalyaData[v]) antalyaData[v].sort().forEach(m=>{let o=document.createElement('option');o.value=m;d.appendChild(o);}); if(s==='inpDistrict')document.getElementById('inpNeighborhood').value=''; if(s==='filterDistrict'){document.getElementById('filterNeighborhood').value='';renderTable();} }
    function renderTable() { 
        const tbody = document.getElementById('tableBody'); tbody.innerHTML = ''; 
        const term = document.getElementById('searchBox').value.toLowerCase(); 
        const fStatus = document.getElementById('filterStatus').value; const fType = document.getElementById('filterType').value; const fRoom = document.getElementById('filterRooms').value; const fDist = document.getElementById('filterDistrict').value; const fNeigh = document.getElementById('filterNeighborhood').value.toLowerCase(); const minP = parsePrice(document.getElementById('filterMinPrice').value); const maxP = parsePrice(document.getElementById('filterMaxPrice').value); 
        const filtered = portfolio.filter(item => { const txt = (item.district + item.neighborhood + item.ref + item.phone + item.desc + item.type).toLowerCase(); const p = parsePrice(item.price); return txt.includes(term) && ((fType === 'all') || (item.type === fType)) && ((fRoom === 'all') || (item.rooms === fRoom)) && ((fStatus === 'all') || (item.status === fStatus)) && (fDist === 'all' || item.district === fDist) && (fNeigh === '' || item.neighborhood.toLowerCase().includes(fNeigh)) && (minP === 0 || p >= minP) && (maxP === 0 || p <= maxP); }); 
        filtered.forEach(item => { 
            let badgeClass = item.status.includes('SatÄ±ldÄ±')||item.status.includes('KiralandÄ±') ? 'kirmizi-etiket' : (item.status==='KiralÄ±k'?'kiralik':'satilik'); let floorInfo = item.floor; if(item.floorCount && item.floorCount.trim() !== "") { floorInfo += `<br><small>Top: ${item.floorCount} Kat</small>`; } let currSymbol = item.currency || 'â‚º'; 
            let btnDesc = item.desc ? `<button onclick="document.getElementById('modalText').innerText='${item.desc.replace(/\n/g,'\\n').replace(/'/g, "\\'")}'; document.getElementById('descModal').style.display='block';" class="btn-icon no-print" style="background:#9b59b6;border:none;color:white;border-radius:3px;cursor:pointer;">ğŸ“</button>` : '-'; 
            tbody.innerHTML += `<tr><td><span class="badge ${badgeClass}">${item.status}</span><br><small>${item.type}</small></td><td><b>${item.district}</b><br><small>${item.neighborhood}</small></td><td>${item.rooms}<br><small>${floorInfo}</small></td><td>${item.gross}/${item.net} mÂ²</td><td style="color:#27ae60;font-weight:bold;">${item.price} ${currSymbol}</td><td>${item.ref}<br><small>${item.phone}</small></td><td>-</td><td class="no-print" style="text-align:center;">-</td><td class="no-print" style="text-align:center;">${btnDesc}</td><td class="no-print"><button onclick="editRecord(${item.id})" style="background:#3498db;color:white;border:none;padding:5px 10px;border-radius:4px;cursor:pointer;">DÃœZENLE</button></td><td class="print-only">${item.desc}</td></tr>`; 
        }); 
    }
    function handleSave() { const data = { id: editingId ? editingId : Date.now(), type: document.getElementById('inpType').value, status: document.getElementById('inpStatus').value, district: document.getElementById('inpDistrict').value, neighborhood: document.getElementById('inpNeighborhood').value, rooms: document.getElementById('inpRooms').value, floor: document.getElementById('inpFloor').value, floorCount: document.getElementById('inpFloorCount').value, gross: document.getElementById('inpGross').value, net: document.getElementById('inpNet').value, price: document.getElementById('inpPrice').value, currency: document.getElementById('inpCurrency').value, authStart: document.getElementById('inpAuthStart').value, authEnd: document.getElementById('inpAuthEnd').value, ref: document.getElementById('inpRef').value, phone: document.getElementById('inpPhone').value, link: document.getElementById('inpLink').value, desc: document.getElementById('inpDesc').value }; if(!data.district || !data.price) { alert("Ä°lÃ§e ve Fiyat zorunlu!"); return; } if (editingId) { portfolio[portfolio.findIndex(p => p.id === editingId)] = data; } else { portfolio.push(data); } saveToDisk(); renderTable(); resetForm(); }
    function editRecord(id) { const item = portfolio.find(p => p.id === id); if(!item) return; editingId = id; document.getElementById('formTitle').innerText = "âœï¸ DÃ¼zenleniyor..."; document.getElementById('btnSave').innerText = "GÃœNCELLE"; document.getElementById('inpType').value = item.type; document.getElementById('inpStatus').value = item.status; document.getElementById('inpDistrict').value = item.district; loadMahalleler('inpDistrict', 'dl_mahalle_ekle'); setTimeout(() => { document.getElementById('inpNeighborhood').value = item.neighborhood; }, 50); document.getElementById('inpRooms').value = item.rooms; document.getElementById('inpFloor').value = item.floor; document.getElementById('inpFloorCount').value = item.floorCount || ''; document.getElementById('inpGross').value = item.gross; document.getElementById('inpNet').value = item.net; document.getElementById('inpPrice').value = item.price; document.getElementById('inpCurrency').value = item.currency || 'â‚º'; document.getElementById('inpRef').value = item.ref; document.getElementById('inpPhone').value = item.phone; document.getElementById('inpLink').value = item.link; document.getElementById('inpDesc').value = item.desc; window.scrollTo(0,0); }
    function deleteFromForm() { if(confirm('SÄ°LÄ°NECEK!')) { portfolio = portfolio.filter(item => item.id !== editingId); saveToDisk(); renderTable(); resetForm(); } }
    function resetForm() { editingId = null; document.getElementById('formTitle').innerText = "â• Yeni PortfÃ¶y Ekle"; document.getElementById('btnSave').innerText = "KAYDET"; document.querySelectorAll('.input-panel input, .input-panel select, .input-panel textarea').forEach(i => i.value = ''); document.getElementById('inpType').value = "Daire"; document.getElementById('inpStatus').value = "SatÄ±lÄ±k"; document.getElementById('inpCurrency').value = "â‚º"; }
    function saveToDisk() { localStorage.setItem('KaracabayRE_EST_DB_v19', JSON.stringify(portfolio)); }
    function downloadData() { const fullBackup = { portfolio: portfolio, crm: crmData }; const content = JSON.stringify(fullBackup, null, 4); const a = document.createElement('a'); a.href = "data:text/plain;charset=utf-8," + encodeURIComponent(content); a.download = "Karacabay_FULL_Yedek_" + new Date().toISOString().slice(0,10) + ".tkt"; document.body.appendChild(a); a.click(); a.remove(); }
    function uploadData(input) { const file = input.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(e) { try { if(confirm("Yedek yÃ¼klensin mi?")) { const data = JSON.parse(e.target.result); if(data.portfolio) { portfolio = data.portfolio; crmData = data.crm || { investors: [], network: [] }; } else { portfolio = data; } saveToDisk(); saveCRM(); renderTable(); alert("YÃ¼klendi!"); } } catch(err) { alert("Dosya hatasÄ±!"); } }; reader.readAsText(file); }
    function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
    function formatPhone(input) { let n = input.value.replace(/\D/g, ''); if(n.length===0){input.value='';return;} if(n[0]!=='0') n='0'+n; n=n.substring(0,11); let f = ""; if(n.length>0) f += n.substring(0,1); if(n.length>1) f += " (" + n.substring(1,4); if(n.length>4) f += ") " + n.substring(4,7); if(n.length>7) f += " " + n.substring(7,9); if(n.length>9) f += " " + n.substring(9,11); input.value = f; }
    function formatPhoneMulti(input) { let lines = input.value.split('\n'); let formattedLines = lines.map(line => { let n = line.replace(/\D/g, ''); if(n.length === 0) return line; if(n[0] !== '0') n = '0' + n; n = n.substring(0, 11); let f = ''; if(n.length > 0) f += n.substring(0, 1); if(n.length > 1) f += ' (' + n.substring(1, 4); if(n.length > 4) f += ') ' + n.substring(4, 7); if(n.length > 7) f += ' ' + n.substring(7, 9); if(n.length > 9) f += ' ' + n.substring(9, 11); return f; }); let newVal = formattedLines.join('\n'); if(input.value !== newVal) { input.value = newVal; } }
    function formatCurrency(input) { let v=input.value.replace(/\D/g, ''); input.value=v.replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
    function parsePrice(v) { return v ? parseInt(v.toString().replace(/\./g,'')) : 0; }
    function openModal(id) { document.getElementById(id).style.display = 'block'; document.body.classList.add('no-scroll'); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; document.body.classList.remove('no-scroll'); }
    function closeModalOutside(e, id) { if(e.target == document.getElementById(id)) closeModal(id); }
    
    // CRM
    function openCRM() { openModal('crmModal'); renderInvestors(); renderNetwork(); document.getElementById('netLastCall').valueAsDate = new Date(); }
    function switchCRMTab(tab) { document.querySelectorAll('.crm-section').forEach(s => s.style.display = 'none'); document.querySelectorAll('.crm-tab').forEach(t => t.classList.remove('active')); if(tab === 'investors') { document.getElementById('crmInvestors').style.display = 'block'; document.getElementById('tab1').classList.add('active'); } else { document.getElementById('crmNetwork').style.display = 'block'; document.getElementById('tab2').classList.add('active'); } resetCRMForm('investors'); resetCRMForm('network'); }
    function saveCRMInvestor() { const inv = { id: crmEditingId ? crmEditingId : Date.now(), name: document.getElementById('invName').value, city: document.getElementById('invCity').value, phone: document.getElementById('invPhone').value, req: document.getElementById('invRequest').value }; if(!inv.name) { alert("Ad Soyad giriniz."); return; } if(crmEditingId) { crmData.investors[crmData.investors.findIndex(i => i.id === crmEditingId)] = inv; } else { crmData.investors.push(inv); } saveCRM(); renderInvestors(); resetCRMForm('investors'); }
    function deleteCRMInvestor() { if(confirm('Silinsin mi?')) { crmData.investors = crmData.investors.filter(i => i.id !== crmEditingId); saveCRM(); renderInvestors(); resetCRMForm('investors'); } }
    function saveCRMNetwork() { const net = { id: crmEditingId ? crmEditingId : Date.now(), name: document.getElementById('netName').value, city: document.getElementById('netCity').value, phone: document.getElementById('netPhone').value, supply: document.getElementById('netSupply').value, lastCall: document.getElementById('netLastCall').value }; if(!net.name) { alert("Ad Soyad giriniz."); return; } if(crmEditingId) { crmData.network[crmData.network.findIndex(n => n.id === crmEditingId)] = net; } else { crmData.network.push(net); } saveCRM(); renderNetwork(); resetCRMForm('network'); }
    function deleteCRMNetwork() { if(confirm('Silinsin mi?')) { crmData.network = crmData.network.filter(n => n.id !== crmEditingId); saveCRM(); renderNetwork(); resetCRMForm('network'); } }
    function resetCRMForm(type) { crmEditingId = null; if(type === 'investors') { document.getElementById('invName').value = ''; document.getElementById('invPhone').value = ''; document.getElementById('invRequest').value = ''; document.getElementById('btnInvSave').innerText = "EKLE"; document.getElementById('btnInvDelete').style.display = "none"; document.getElementById('btnInvCancel').style.display = "none"; } else { document.getElementById('netName').value = ''; document.getElementById('netPhone').value = ''; document.getElementById('netSupply').value = ''; document.getElementById('netLastCall').valueAsDate = new Date(); document.getElementById('btnNetSave').innerText = "EKLE"; document.getElementById('btnNetDelete').style.display = "none"; document.getElementById('btnNetCancel').style.display = "none"; } }
    function renderInvestors() { const tbody = document.getElementById('investorTableBody'); tbody.innerHTML = ''; crmData.investors.forEach(inv => { tbody.innerHTML += `<tr><td><b>${inv.name}</b></td><td>${inv.city}</td><td style="white-space:pre-wrap;">${inv.phone}</td><td style="white-space:pre-wrap;">${inv.req}</td><td><button onclick="editCRMInvestor(${inv.id})" style="background:#3498db;color:white;border:none;border-radius:3px;padding:4px 8px;cursor:pointer;">DÃœZENLE</button></td></tr>`; }); }
    function renderNetwork() { const tbody = document.getElementById('networkTableBody'); tbody.innerHTML = ''; const today = new Date(); crmData.network.forEach(net => { let statusHtml = '<span class="crm-status-badge" style="background:#eee; color:#333;">Yeni</span>'; let rowClass = ''; if(net.lastCall) { const lastDate = new Date(net.lastCall); const diffTime = Math.abs(today - lastDate); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); if(diffDays > 45) { rowClass = 'row-alert'; statusHtml = `<span class="crm-status-badge" style="background:white; color:#c0392b;">âš ï¸ ${diffDays} GÃ¼n!</span>`; } else if (diffDays > 30) { rowClass = 'row-warning'; statusHtml = `<span class="crm-status-badge" style="background:white; color:#e67e22;">â³ ${diffDays} GÃ¼n</span>`; } else { statusHtml = `<span class="crm-status-badge" style="background:#27ae60; color:white;">âœ… ${diffDays} GÃ¼n</span>`; } } tbody.innerHTML += `<tr class="${rowClass}"><td>${statusHtml}</td><td><b>${net.name}</b></td><td>${net.city}</td><td style="white-space:pre-wrap;">${net.phone}</td><td style="white-space:pre-wrap;">${net.supply}</td><td>${net.lastCall ? net.lastCall.split('-').reverse().join('.') : '-'}</td><td><button onclick="updateCallDate(${net.id})" style="background:#2980b9; color:white; border:none; padding:5px; border-radius:3px; cursor:pointer; font-size:11px;">âœ… GÃ¶rÃ¼ÅŸtÃ¼m (SÄ±fÄ±rla)</button></td><td><button onclick="editCRMNetwork(${net.id})" style="background:#3498db; color:white; border:none; padding:4px 8px; border-radius:3px; cursor:pointer;">DÃœZENLE</button></td></tr>`; }); }
    function updateCallDate(id) { const idx = crmData.network.findIndex(n => n.id === id); if(idx !== -1) { crmData.network[idx].lastCall = new Date().toISOString().split('T')[0]; saveCRM(); renderNetwork(); } }
    function saveCRM() { localStorage.setItem('KaracabayRE_CRM_v19', JSON.stringify(crmData)); }
    
    // Tools
    let calcExp = ""; function calcInput(v) { calcExp += v; document.getElementById('calcDisplay').value = calcExp; } function calcClear() { calcExp = ""; document.getElementById('calcDisplay').value = ""; } function calcResult() { try { calcExp = eval(calcExp).toString(); document.getElementById('calcDisplay').value = calcExp; } catch(e) { document.getElementById('calcDisplay').value = "Hata"; calcExp=""; } }
    async function fetchCurrency() { try { const res = await fetch('https://api.exchangerate-api.com/v4/latest/TRY'); const data = await res.json(); if(document.getElementById('usdRate').value === "") document.getElementById('usdRate').value = (1 / data.rates.USD).toFixed(4); if(document.getElementById('eurRate').value === "") document.getElementById('eurRate').value = (1 / data.rates.EUR).toFixed(4); } catch(e) {} }
    function calculateCurrencyTotal() { let amount = parseFloat(document.getElementById('calcCurrAmount').value); let type = document.getElementById('calcCurrType').value; let rate = type === 'USD' ? parseFloat(document.getElementById('usdRate').value) : parseFloat(document.getElementById('eurRate').value); if(!amount || !rate) return; document.getElementById('currResText').innerText = (amount * rate).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " TL"; document.getElementById('currencyTotalRes').style.display = 'block'; }
    function switchTab(id) { document.querySelectorAll('.tab-content').forEach(d => d.style.display='none'); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(id).style.display = 'block'; event.currentTarget.classList.add('active'); }
    function calcTapuKomisyon() { let p = parseFloat(document.getElementById('calcPrice').value); if(!p) return; let tapu = p * 0.04; let kom = p * 0.02 * 1.20; document.getElementById('resTapu').innerHTML = `<strong>Tapu HarcÄ± (%4):</strong> ${tapu.toLocaleString()} TL<br><strong>Komisyon (%2+KDV):</strong> ${kom.toLocaleString()} TL`; document.getElementById('resTapu').style.display = 'block'; }
    function calcEmsal() { let m2 = parseFloat(document.getElementById('calcArsaM2').value); let kaks = parseFloat(document.getElementById('calcKaks').value); if(!m2 || !kaks) return; document.getElementById('resEmsal').innerHTML = `Ä°nÅŸaat AlanÄ±: <strong>${(m2*kaks).toLocaleString()} mÂ²</strong>`; document.getElementById('resEmsal').style.display = 'block'; }
    function calcEmlakVergisi() { let val = parseFloat(document.getElementById('calcVergiDeger').value); let rate = parseFloat(document.getElementById('calcVergiType').value); if(!val) return; document.getElementById('resVergi').innerHTML = `Vergi: <strong>${(val*rate).toLocaleString()} TL</strong>`; document.getElementById('resVergi').style.display = 'block'; }

    // ==========================================
    // v3.8 ENTEGRASYON KODU (IFRAME YÃ–NETÄ°MÄ°)
    // ==========================================
    function openCrmV38() {
        const overlay = document.getElementById('crmV38Overlay');
        const frame = document.getElementById('crmFrame');
        overlay.style.display = 'block';
        document.body.classList.add('no-scroll');

        // v3.8 KAYNAK KODU (String iÃ§inde Sandboxed)
        const v38Source = `
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emlak CRM v3.8</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .nav-pills .nav-link.active { background-color: #0d6efd; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .form-section-title { font-weight: 600; color: #495057; border-bottom: 2px solid #e9ecef; padding-bottom: 5px; margin-bottom: 15px; margin-top: 15px; }
        #map { height: 300px; width: 100%; border-radius: 8px; z-index: 1; }
        .preview-img { max-width: 100%; max-height: 250px; border-radius: 8px; display: none; margin-top: 10px; border: 2px solid #ddd; }
        .feature-tag { display: inline-block; font-size: 0.8rem; margin-right: 5px; margin-bottom: 2px; color: #444; background: #fff; border: 1px solid #eee; padding: 2px 6px; border-radius: 4px; }
        .admin-box { background-color: #fff3cd; border: 2px dashed #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        @media print { body > * { display: none !important; } #viewModal { display: block !important; position: absolute !important; left: 0 !important; top: 0 !important; width: 100% !important; height: auto !important; z-index: 9999 !important; } #printArea { display: block !important; visibility: visible !important; } }
    </style>
</head>
<body>
<div class="container py-4">
    <h2 class="text-primary fw-bold mb-4">ğŸ› ï¸ Emlak CRM v3.8 (ModÃ¼l)</h2>
    <ul class="nav nav-pills mb-4 nav-justified" id="mainTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-identity">1. Kimlik</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-tech">2. Teknik</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-loc" onclick="resizeMap()">3. Konum</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-features">4. Ã–zellikler</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-media">5. Medya</button></li>
        <li class="nav-item"><button class="nav-link bg-dark text-white" data-bs-toggle="pill" data-bs-target="#tab-list" onclick="loadList()">ğŸ“‹ KayÄ±tlar</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-identity">
            <div class="card p-4">
                <div class="alert alert-secondary mb-4">
                    <h6 class="fw-bold text-dark">ğŸ” Gizli Alan (YÃ¶netici)</h6>
                    <div class="row g-2">
                        <div class="col-md-3"><input type="text" class="form-control form-control-sm" id="ownerName" placeholder="Mal Sahibi Ad"></div>
                        <div class="col-md-3"><input type="tel" class="form-control form-control-sm" id="ownerTel" placeholder="Telefon"></div>
                        <div class="col-md-3"><input type="date" class="form-control form-control-sm" id="authStart"></div>
                        <div class="col-md-3"><input type="date" class="form-control form-control-sm" id="authEnd"></div>
                    </div>
                </div>
                <h5 class="form-section-title">Temel Bilgiler</h5>
                <input type="hidden" id="recordId">
                <div class="row g-3">
                    <div class="col-12"><label>BaÅŸlÄ±k</label><input type="text" class="form-control" id="title"></div>
                    <div class="col-12"><label>AÃ§Ä±klama</label><textarea class="form-control" id="desc" rows="3"></textarea></div>
                    <div class="col-md-4"><label>Fiyat</label><input type="text" class="form-control" id="price"></div>
                    <div class="col-md-2"><label>Birim</label><select class="form-select" id="currency"><option>TL</option><option>USD</option><option>EUR</option></select></div>
                    <div class="col-md-3"><label>TÃ¼r</label><select class="form-select" id="adType"><option>SatÄ±lÄ±k</option><option>KiralÄ±k</option></select></div>
                    <div class="col-md-3"><label>Kategori</label><select class="form-select" id="propType"><option>Daire</option><option>Villa</option><option>Arsa</option><option>Ä°ÅŸyeri</option></select></div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-tech">
            <div class="card p-4">
                <div class="row g-3">
                    <div class="col-md-3"><label>BrÃ¼t mÂ²</label><input type="number" class="form-control" id="grossM2"></div>
                    <div class="col-md-3"><label>Net mÂ²</label><input type="number" class="form-control" id="netM2"></div>
                    <div class="col-md-3"><label>Oda</label><select class="form-select" id="rooms"><option>1+1</option><option>2+1</option><option>3+1</option><option>Villa</option></select></div>
                    <div class="col-md-3"><label>Kat</label><input type="text" class="form-control" id="floorCurr"></div>
                    <div class="col-md-3"><label>Bina YaÅŸÄ±</label><input type="text" class="form-control" id="age"></div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-loc">
            <div class="card p-4">
                <div class="row g-2">
                    <div class="col-md-4"><input type="text" class="form-control" id="city" value="Antalya"></div>
                    <div class="col-md-4"><input type="text" class="form-control" id="district" placeholder="Ä°lÃ§e"></div>
                    <div class="col-md-4"><input type="text" class="form-control" id="neighborhood" placeholder="Mahalle"></div>
                    <div class="col-12 mt-3"><div id="map"></div></div>
                    <input type="hidden" id="lat"><input type="hidden" id="lng">
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-features">
            <div class="card p-4">
                <h6>Cephe</h6>
                <div class="btn-group w-100 mb-3"><input type="checkbox" class="btn-check feat" id="f_k" value="Kuzey"><label class="btn btn-outline-secondary" for="f_k">Kuzey</label><input type="checkbox" class="btn-check feat" id="f_g" value="GÃ¼ney"><label class="btn btn-outline-secondary" for="f_g">GÃ¼ney</label></div>
                <h6>Ã–zellikler</h6>
                <div class="row">
                    <div class="col-4"><input type="checkbox" class="feat" value="Ankastre"> Ankastre</div>
                    <div class="col-4"><input type="checkbox" class="feat" value="Klima"> Klima</div>
                    <div class="col-4"><input type="checkbox" class="feat" value="Havuz"> Havuz</div>
                    <div class="col-4"><input type="checkbox" class="feat" value="Otopark"> Otopark</div>
                    <div class="col-4"><input type="checkbox" class="feat" value="AsansÃ¶r"> AsansÃ¶r</div>
                    <div class="col-4"><input type="checkbox" class="feat" value="GÃ¼venlik"> GÃ¼venlik</div>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-media">
            <div class="card p-4 text-center">
                <h5>ğŸ“¸ FotoÄŸraf</h5>
                <input type="file" class="form-control" id="photoInput" onchange="previewPhoto()">
                <img id="photoPreview" class="preview-img mx-auto">
                <input type="hidden" id="photoBase64">
                <button class="btn btn-success btn-lg mt-4" onclick="saveRecord()">âœ… KAYDET</button>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-list">
            <div class="card p-3">
                <h5>ğŸ“‹ KayÄ±tlÄ± Raporlar</h5>
                <div id="listContainer"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="viewModal" tabindex="-1">
    <div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Rapor</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body" id="printArea"></div><div class="modal-footer"><button onclick="window.print()" class="btn btn-primary">YazdÄ±r</button></div></div></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"><\/script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"><\/script>
<script>
    let db = []; // VERÄ°TABANI
    
    // --- DIÅARIDAN VERÄ° ALMA (v27 Entegrasyonu) ---
    window.addEventListener('message', function(e) {
        if(e.data.type === 'INIT') {
            db = e.data.payload || [];
            loadList();
        }
    });

    var map = L.map('map').setView([36.88, 30.70], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    function resizeMap() { setTimeout(() => { map.invalidateSize(); }, 300); }
    map.on('click', function(e) { L.marker(e.latlng).addTo(map); document.getElementById('lat').value=e.latlng.lat; document.getElementById('lng').value=e.latlng.lng; });

    function previewPhoto() { const f=document.getElementById('photoInput').files[0]; const r=new FileReader(); r.onload=e=>{document.getElementById('photoPreview').src=e.target.result; document.getElementById('photoPreview').style.display='block'; document.getElementById('photoBase64').value=e.target.result;}; if(f)r.readAsDataURL(f); }

    function saveRecord() {
        const id = document.getElementById('recordId').value || 'ID'+Date.now();
        const rec = {
            id,
            ownerName: document.getElementById('ownerName').value, ownerTel: document.getElementById('ownerTel').value,
            authStart: document.getElementById('authStart').value, authEnd: document.getElementById('authEnd').value,
            title: document.getElementById('title').value, desc: document.getElementById('desc').value, price: document.getElementById('price').value, currency: document.getElementById('currency').value,
            adType: document.getElementById('adType').value, propType: document.getElementById('propType').value,
            grossM2: document.getElementById('grossM2').value, netM2: document.getElementById('netM2').value, rooms: document.getElementById('rooms').value,
            city: document.getElementById('city').value, district: document.getElementById('district').value, neighborhood: document.getElementById('neighborhood').value,
            features: [...document.querySelectorAll('.feat:checked')].map(c=>c.value),
            photo: document.getElementById('photoBase64').value
        };
        const idx = db.findIndex(x=>x.id===id); if(idx>-1) db[idx]=rec; else db.push(rec);
        
        // v27'YE GÃ–NDER
        window.parent.postMessage({type: 'SAVE', payload: db}, '*');
        
        alert('Kaydedildi!'); loadList();
    }

    function loadList() {
        const c = document.getElementById('listContainer'); c.innerHTML='';
        db.forEach(r => {
            c.innerHTML += \`<div class="d-flex justify-content-between border p-2 mb-2"><div><b>\${r.title}</b><br>\${r.price} \${r.currency}</div><div><button class="btn btn-info btn-sm" onclick="viewRec('\${r.id}',false)">ğŸ‘ï¸ MÃ¼ÅŸteri</button> <button class="btn btn-warning btn-sm" onclick="viewRec('\${r.id}',true)">ğŸ”’ Admin</button> <button class="btn btn-primary btn-sm" onclick="editRec('\${r.id}')">âœï¸</button></div></div>\`;
        });
    }

    function viewRec(id, isAdmin) {
        const r = db.find(x=>x.id===id); if(!r) return;
        let adminHtml = isAdmin ? \`<div class="admin-box"><b>YÃ–NETÄ°CÄ°:</b> \${r.ownerName} - \${r.ownerTel}</div>\` : '';
        let html = \`\${adminHtml}<h1>\${r.title}</h1><h3>\${r.price} \${r.currency}</h3><img src="\${r.photo}" style="max-width:100%"><p>\${r.desc}</p><hr><p>\${r.city}/\${r.district}/\${r.neighborhood}</p>\`;
        document.getElementById('printArea').innerHTML = html;
        new bootstrap.Modal(document.getElementById('viewModal')).show();
    }
    
    function editRec(id) {
        const r = db.find(x=>x.id===id); if(!r) return;
        document.getElementById('recordId').value=r.id;
        document.getElementById('title').value=r.title;
        document.getElementById('price').value=r.price;
        // ... DiÄŸer alanlar doldurulabilir ...
        new bootstrap.Tab(document.querySelector('#mainTab button[data-bs-target="#tab-identity"]')).show();
    }
<\/script>
</body>
</html>
        `;
        
        frame.srcdoc = v38Source;

        // VERÄ° SENKRONÄ°ZASYONU (v27 -> v3.8)
        frame.onload = function() {
            setTimeout(() => {
                // Mevcut veritabanÄ±nÄ± v3.8'e gÃ¶nder
                const currentDB = JSON.parse(localStorage.getItem('KaracabayRE_EST_DB_v19')) || [];
                frame.contentWindow.postMessage({ type: 'INIT', payload: currentDB }, '*');
            }, 500);
        };
    }

    function closeCrmV38() {
        document.getElementById('crmV38Overlay').style.display = 'none';
        document.body.classList.remove('no-scroll');
        location.reload(); // Verileri tazelemek iÃ§in sayfayÄ± yenile (Opsiyonel)
    }

    // VERÄ° SENKRONÄ°ZASYONU (v3.8 -> v27)
    window.addEventListener('message', function(e) {
        if(e.data.type === 'SAVE') {
            const updatedDB = e.data.payload;
            portfolio = updatedDB;
            saveToDisk(); // v27 VeritabanÄ±na Yaz
            renderTable(); // v27 Tablosunu GÃ¼ncelle
        }
    });

</script>
</body>
</html>
