<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="description" content="KARACABAYRE.EST - KiÅŸisel Emlak YÃ¶netim Paneli">
    <meta name="robots" content="noindex, nofollow, noarchive">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KARACABAYRE.EST - v28 Ultimate</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #27ae60;
            --danger: #c0392b;
            --sold: #d63031;
            --tool-bg: #f8f9fa;
            --warning-bg: #fff3cd;
            --alert-bg: #f8d7da;
        }
        body { font-family: 'Segoe UI', sans-serif; background: #eef2f3; margin: 0; padding: 20px; color: #333; }
        body.no-scroll { overflow: hidden; } 

        /* GÄ°RÄ°Å EKRANI */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2c3e50; z-index: 99999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .login-box { background: white; padding: 30px; border-radius: 10px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); width: 300px; }
        .login-box input { width: 80%; padding: 10px; margin: 15px 0; font-size: 18px; text-align: center; border: 2px solid #ddd; border-radius: 5px; }
        .login-box button { width: 90%; padding: 10px; background: #27ae60; color: white; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; }

        /* ANA UYGULAMA */
        #appContainer { display: none; }
        .container { max-width: 1800px; margin: 0 auto; background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        /* Header & Toolbar */
        header { display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .backup-controls { display: flex; gap: 10px; }
        .btn-backup { background: #f39c12; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 13px; display: flex; align-items: center; gap: 5px; }
        .tools-bar { display: flex; gap: 10px; background: var(--tool-bg); padding: 10px; border-radius: 6px; margin-bottom: 25px; border: 1px solid #ddd; flex-wrap: wrap; align-items: center; }
        .tool-btn { background: white; border: 1px solid #ccc; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 8px; transition: all 0.2s; text-decoration: none; }
        .tool-btn:hover { background: var(--secondary); color: white; border-color: var(--secondary); }
        .report-btn { background: #e8f6f3; color: #16a085; border-color: #16a085; } .report-btn:hover { background: #16a085; }

        /* Form & Inputs */
        .input-panel { background: #fdfdfd; padding: 20px; border: 1px solid #ddd; border-left: 6px solid var(--primary); margin-bottom: 30px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 15px; }
        .form-group label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 5px; color: #555; text-transform: uppercase; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; box-sizing: border-box; }
        textarea.auto-expand { overflow-y: hidden; min-height: 40px; resize: none; transition: height 0.1s; }
        .currency-group { display: flex; gap: 5px; }
        .currency-group select { width: 70px; flex-shrink: 0; background: #eee; font-weight: bold; }
        .auth-box { grid-column: span 2; display: flex; gap: 15px; background: #eafaf1; padding: 15px; border: 1px dashed var(--accent); border-radius: 6px; }
        .form-buttons { grid-column: span 2; display: flex; gap: 10px; margin-top: 10px; }
        .btn-save { background: var(--accent); color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; flex: 2; }
        .btn-delete-rec { background: var(--danger); color: white; border: none; padding: 10px; border-radius: 4px; cursor: pointer; font-weight: bold; display: none; }
        .btn-cancel { background: #7f8c8d; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; display: none; }

        /* Tables & Filters */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 13px; table-layout: fixed; }
        th { background: #34495e; color: white; padding: 12px; text-align: left; vertical-align: middle; }
        td { padding: 10px; border-bottom: 1px solid #eee; vertical-align: middle; word-wrap: break-word; }
        tr:hover { background: #f9f9f9; }
        .badge { padding: 4px 8px; border-radius: 4px; color: white; font-size: 11px; font-weight: bold; display:inline-block; }
        .satilik { background: var(--secondary); } .kiralik { background: #e67e22; } .kirmizi-etiket { background: var(--sold) !important; }
        .filter-bar { background: var(--primary); padding: 15px; border-radius: 6px; display: flex; gap: 10px; flex-wrap: wrap; color: white; align-items: center; }
        .filter-bar input, .filter-bar select { padding: 8px; border: none; border-radius: 4px; color: #333; }
        .direct-link-btn { display: inline-block; background-color: #3498db; color: white; text-decoration: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; font-weight: 600; }
        .link-sahibinden { background-color: #f1c40f; color: black; } .link-hepsi { background-color: #e74c3c; } .link-obudur { background-color: #8e44ad; } .link-emlakjet { background-color: #2ecc71; } .link-dosya { background-color: #95a5a6; border: 1px solid #7f8c8d; } .link-sosyal { background-color: #d63031; }

        /* MODALS (Ortak YapÄ±) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; overflow-y: hidden; }
        .modal-content { background: white; margin: 2% auto; padding: 25px; width: 90%; border-radius: 8px; position: relative; max-height: 90vh; display: flex; flex-direction: column; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .modal-close { position: absolute; right: 20px; top: 15px; font-size: 24px; cursor: pointer; color: #555; }
        .modal-title { font-size: 1.2em; font-weight: bold; color: var(--primary); margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }

        /* RAPOR MODÃœLÃœ Ã–ZEL STÄ°LLERÄ° (v3.8 UyarlamasÄ±) */
        .report-tabs { display: flex; border-bottom: 2px solid #eee; margin-bottom: 15px; overflow-x: auto; }
        .report-tab { padding: 10px 20px; cursor: pointer; border-bottom: 3px solid transparent; font-weight: 600; color: #555; white-space: nowrap; }
        .report-tab.active { border-bottom-color: var(--secondary); color: var(--secondary); background: #f9f9f9; }
        .report-pane { display: none; } .report-pane.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .feature-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 8px; margin-top: 10px; }
        .feature-item { display: flex; align-items: center; gap: 5px; font-size: 13px; background: #f8f9fa; padding: 5px; border: 1px solid #eee; border-radius: 4px; }
        
        #map { height: 300px; width: 100%; border-radius: 8px; z-index: 1; border: 1px solid #ccc; margin-top: 10px; }
        .report-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .report-list-item:hover { background: #f9f9f9; }
        
        /* RAPOR GÃ–RÃœNTÃœLEME MODU (Print Area) */
        #printArea { font-family: 'Segoe UI', sans-serif; display: none; }
        .doc-label { font-weight: 600; color: #555; width: 140px; }
        .doc-value { color: #000; font-weight: 500; }
        .doc-price { font-size: 1.6rem; color: #198754; font-weight: bold; }
        .admin-box { background-color: #fff3cd; border: 2px dashed #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .feature-tag { display: inline-block; font-size: 0.8rem; margin: 2px; color: #444; background: #fff; border: 1px solid #ccc; padding: 2px 6px; border-radius: 4px; }

        /* BaskÄ± AyarlarÄ± */
        @media print { 
            body * { visibility: hidden; }
            #printArea, #printArea * { visibility: visible; display: block !important; }
            #printArea { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; }
            .modal, .input-panel, header, .tools-bar { display: none !important; }
        }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h2>ğŸ”’ GÃœVENLÄ° GÄ°RÄ°Å</h2>
        <p>KaracabayRE.EST Sistemine EriÅŸmek Ä°Ã§in Åifre Giriniz</p>
        <input type="password" id="loginPin" placeholder="Åifre (1923)" inputmode="numeric">
        <button onclick="checkLogin()">GÄ°RÄ°Å YAP</button>
    </div>
</div>

<div id="appContainer">
    <div class="container">
        <header>
            <div><h1>ğŸ¢ KARACABAYRE.EST <span style="font-size:12px; color:#27ae60; border:1px solid #27ae60; padding:2px 8px; border-radius:10px;">ULTIMATE v28</span></h1></div>
            <div class="backup-controls">
                <input type="file" id="fileUpload" style="display:none;" onchange="uploadData(this)">
                <button class="btn-backup btn-upload" onclick="document.getElementById('fileUpload').click()">ğŸ“‚ YÃœKLE</button>
                <button class="btn-backup" onclick="downloadData()">ğŸ’¾ YEDEKLE</button>
            </div>
        </header>

        <div class="tools-bar">
            <button class="tool-btn report-btn" onclick="openReportModule()"><i class="fa-solid fa-file-contract"></i> <b>DetaylÄ± Rapor OluÅŸtur</b></button>
            <button class="tool-btn crm-btn" onclick="openCRM()"><i class="fa-solid fa-users"></i> CRM</button>
            <button class="tool-btn" onclick="openModal('calcModal')"><i class="fa-solid fa-calculator"></i> Hesap Makinesi</button>
            <button class="tool-btn" onclick="openModal('currencyModal'); fetchCurrency();"><i class="fa-solid fa-money-bill-transfer"></i> DÃ¶viz</button>
            <button class="tool-btn" onclick="openModal('realEstateCalcModal')"><i class="fa-solid fa-calculator"></i> Hesaplamalar</button>
            <a href="https://parselsorgu.tkgm.gov.tr/" target="_blank" class="tool-btn tkgm-btn"><i class="fa-solid fa-map-location-dot"></i> TKGM</a>
        </div>

        <div class="input-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <span id="formTitle" style="font-weight:bold; color:var(--primary); font-size:1.1em;">âš¡ HÄ±zlÄ± PortfÃ¶y Ekle</span>
                <button id="btnCancel" class="btn-cancel" onclick="resetForm()">TEMÄ°ZLE</button>
            </div>
            <div class="form-grid">
                <div class="form-group"><label>Menkul Cinsi</label><select id="inpType"></select></div>
                <div class="form-group"><label>Ä°ÅŸlem TÃ¼rÃ¼</label><select id="inpStatus"><option>SatÄ±lÄ±k</option><option>KiralÄ±k</option><option>Devren</option><option style="color:red;">SatÄ±ldÄ±</option><option style="color:red;">KiralandÄ±</option></select></div>
                <div class="form-group"><label>Ä°lÃ§e</label><select id="inpDistrict" onchange="loadMahalleler('inpDistrict', 'dl_mahalle_ekle')"><option value="">SeÃ§iniz</option></select></div>
                <div class="form-group"><label>Mahalle</label><input type="text" list="dl_mahalle_ekle" id="inpNeighborhood" placeholder="YazÄ±nÄ±z..." autocomplete="off"><datalist id="dl_mahalle_ekle"></datalist></div>
                <div class="form-group"><label>Oda</label><select id="inpRooms"></select></div>
                <div class="form-group"><label>Kat</label><select id="inpFloor"></select></div>
                <div class="form-group"><label>Bina KatÄ±</label><input type="number" id="inpFloorCount"></div>
                <div class="form-group"><label>mÂ² (BrÃ¼t/Net)</label><div style="display:flex; gap:5px;"><input type="number" id="inpGross" placeholder="BrÃ¼t"><input type="number" id="inpNet" placeholder="Net"></div></div>
                <div class="form-group"><label>Fiyat</label><div class="currency-group"><input type="text" id="inpPrice" oninput="formatCurrency(this)"><select id="inpCurrency"><option value="â‚º">TL</option><option value="$">USD</option><option value="â‚¬">EUR</option><option value="Â£">GBP</option></select></div></div>
                <div class="auth-box">
                    <div class="form-group" style="flex:1;"><label>Yetki BaÅŸlangÄ±Ã§</label><input type="date" id="inpAuthStart"></div>
                    <div class="form-group" style="flex:1;"><label>Yetki BitiÅŸ</label><input type="date" id="inpAuthEnd"></div>
                </div>
                <div class="form-group"><label>MÃ¼ÅŸteri Ad Soyad</label><input type="text" id="inpRef"></div>
                <div class="form-group"><label>Telefon</label><input type="text" id="inpPhone" oninput="formatPhone(this)"></div>
                <div class="form-group"><label>Link / Dosya</label><textarea id="inpLink" rows="1" class="auto-expand" oninput="autoResize(this)"></textarea></div>
                <div class="form-group" style="grid-column:span 2;"><label>AÃ§Ä±klama</label><textarea id="inpDesc" class="auto-expand" oninput="autoResize(this)"></textarea></div>
                <div class="form-buttons">
                    <button id="btnSave" class="btn-save" onclick="handleSave()">KAYDET</button>
                    <button id="btnDelete" class="btn-delete-rec" onclick="deleteFromForm()">SÄ°L</button>
                </div>
            </div>
        </div>

        <div class="filter-bar">
            <span>ğŸ” ARA:</span> <input type="text" id="searchBox" placeholder="Ara..." onkeyup="renderTable()" style="width:120px;">
            <select id="filterType" onchange="renderTable()" style="width:110px;"><option value="all">TÃ¼m Tipler</option></select>
            <select id="filterStatus" onchange="renderTable()" style="width:100px;"><option value="all">Durum</option><option>SatÄ±lÄ±k</option><option>KiralÄ±k</option><option>Devren</option><option>SatÄ±ldÄ±</option><option>KiralandÄ±</option></select>
            <select id="filterDistrict" onchange="loadMahalleler('filterDistrict', 'dl_mahalle_filtre')"><option value="all">Ä°lÃ§e</option></select>
            <input type="text" list="dl_mahalle_filtre" id="filterNeighborhood" placeholder="Mahalle" onkeyup="renderTable()" style="width:100px;" autocomplete="off"><datalist id="dl_mahalle_filtre"></datalist>
            <input type="text" id="filterMinPrice" placeholder="Min" oninput="formatCurrency(this); renderTable()" style="width:80px;"> 
            <input type="text" id="filterMaxPrice" placeholder="Max" oninput="formatCurrency(this); renderTable()" style="width:80px;">
        </div>
        <table id="portfolioTable"><thead><tr><th width="8%">TÃ¼r</th><th width="12%">Lokasyon</th><th width="8%">Ã–zellik</th><th width="10%">mÂ²</th><th width="11%">Fiyat</th><th width="14%">MÃ¼ÅŸteri</th><th width="9%">Yetki</th><th class="no-print" width="6%">Link</th><th class="no-print" width="5%">Not</th><th class="no-print" width="8%">Ä°ÅŸlem</th></tr></thead><tbody id="tableBody"></tbody></table>
    </div>
</div>

<div id="reportModal" class="modal" onclick="closeModalOutside(event, 'reportModal')">
    <div class="modal-content" style="width:95%; max-width:1100px;">
        <span class="modal-close" onclick="closeModal('reportModal')">&times;</span>
        <div class="modal-title">ğŸ“„ DetaylÄ± Rapor OluÅŸturucu</div>
        
        <div class="report-tabs">
            <div class="report-tab active" onclick="switchReportTab('rt-kimlik')">1. Kimlik & Finans</div>
            <div class="report-tab" onclick="switchReportTab('rt-teknik')">2. Teknik Detay</div>
            <div class="report-tab" onclick="switchReportTab('rt-konum'); resizeMap()">3. Konum (Harita)</div>
            <div class="report-tab" onclick="switchReportTab('rt-ozellik')">4. Ã–zellikler</div>
            <div class="report-tab" onclick="switchReportTab('rt-medya')">5. Medya & Ã‡Ä±ktÄ±</div>
            <div class="report-tab" style="margin-left:auto; color:#d35400;" onclick="switchReportTab('rt-liste'); loadReportList()">ğŸ“‹ KayÄ±tlÄ± Raporlar</div>
        </div>

        <input type="hidden" id="repId"> <div id="rt-kimlik" class="report-pane active">
            <div class="form-grid" style="border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:10px;">
                <div class="auth-box" style="grid-column: span 4;">
                    <strong>ğŸ”’ Gizli Alan (YÃ¶netici Ä°Ã§in):</strong>
                    <div class="form-grid">
                        <div class="form-group"><label>Mal Sahibi</label><input type="text" id="repOwner"></div>
                        <div class="form-group"><label>Telefon</label><input type="text" id="repPhone"></div>
                    </div>
                </div>
            </div>
            <div class="form-grid">
                <div class="form-group" style="grid-column: span 2;"><label>BaÅŸlÄ±k</label><input type="text" id="repTitle" placeholder="Ã–rn: Denize SÄ±fÄ±r Villa"></div>
                <div class="form-group"><label>Fiyat</label><input type="text" id="repPrice" oninput="formatCurrency(this)"></div>
                <div class="form-group"><label>Birim</label><select id="repCurr"><option>TL</option><option>USD</option><option>EUR</option></select></div>
                <div class="form-group"><label>Ä°lan TÃ¼rÃ¼</label><select id="repAdType"><option>SatÄ±lÄ±k</option><option>KiralÄ±k</option></select></div>
                <div class="form-group"><label>Kategori</label><select id="repPropType"><option>Daire</option><option>Villa</option><option>Arsa</option><option>Ä°ÅŸyeri</option></select></div>
                <div class="form-group" style="grid-column: span 4;"><label>AÃ§Ä±klama</label><textarea id="repDesc" rows="3"></textarea></div>
                <div class="form-group"><label>Krediye Uygun?</label><select id="repCredit"><option>Evet</option><option>HayÄ±r</option></select></div>
                <div class="form-group"><label>Takas?</label><select id="repSwap"><option>HayÄ±r</option><option>Evet</option></select></div>
            </div>
        </div>

        <div id="rt-teknik" class="report-pane">
            <div class="form-grid">
                <div class="form-group"><label>BrÃ¼t mÂ²</label><input type="number" id="repGross"></div>
                <div class="form-group"><label>Net mÂ²</label><input type="number" id="repNet"></div>
                <div class="form-group"><label>Oda</label><select id="repRoom"><option>1+1</option><option>2+1</option><option>3+1</option><option>4+1</option><option>Villa</option></select></div>
                <div class="form-group"><label>Bina YaÅŸÄ±</label><input type="text" id="repAge"></div>
                <div class="form-group"><label>Kat</label><input type="text" id="repFloor"></div>
                <div class="form-group"><label>Banyo</label><input type="number" id="repBath" value="1"></div>
                <div class="form-group"><label>IsÄ±tma</label><select id="repHeat"><option>Klima</option><option>Kombi</option><option>Merkezi</option><option>Yok</option></select></div>
                <div class="form-group"><label>Tapu Durumu</label><select id="repTapu"><option>Kat MÃ¼lkiyeti</option><option>Kat Ä°rtifakÄ±</option><option>Arsa PaylÄ±</option></select></div>
                <div class="form-group"><label>Ada / Parsel</label><div style="display:flex; gap:5px;"><input type="text" id="repAda" placeholder="Ada"><input type="text" id="repParsel" placeholder="Parsel"></div></div>
            </div>
        </div>

        <div id="rt-konum" class="report-pane">
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <input type="text" id="repCity" placeholder="Ä°l" style="flex:1; padding:8px;">
                <input type="text" id="repDistrict" placeholder="Ä°lÃ§e" style="flex:1; padding:8px;">
                <input type="text" id="repNeigh" placeholder="Mahalle" style="flex:1; padding:8px;">
                <button class="btn-save" onclick="getLocation()" style="flex:0;">ğŸ“ Konum Bul</button>
            </div>
            <div id="map"></div>
            <input type="hidden" id="repLat"><input type="hidden" id="repLng">
        </div>

        <div id="rt-ozellik" class="report-pane">
            <div style="font-weight:bold; margin-top:10px;">Cephe:</div>
            <div class="feature-grid">
                <label class="feature-item"><input type="checkbox" class="rep-feat" value="Kuzey"> Kuzey</label>
                <label class="feature-item"><input type="checkbox" class="rep-feat" value="GÃ¼ney"> GÃ¼ney</label>
                <label class="feature-item"><input type="checkbox" class="rep-feat" value="DoÄŸu"> DoÄŸu</label>
                <label class="feature-item"><input type="checkbox" class="rep-feat" value="BatÄ±"> BatÄ±</label>
            </div>
            <div style="font-weight:bold; margin-top:10px;">Ä°Ã§ Ã–zellikler:</div>
            <div class="feature-grid">
                <label class="feature-item"><input type="checkbox" class="rep-feat" value="Ankastre"> Ankastre</label>
                <label class="feature-item"><input type="checkbox" class="rep-feat" value="Ebeveyn Banyosu"> Ebeveyn Ban.</label>
                <label class="feature-item"><input type="checkbox" class="rep-feat" value="Giyinme OdasÄ±"> Giyinme OdasÄ±</label>
                <label class="feature-item"><input type="checkbox" class="rep-feat" value="Klima"> Klima</label>
                <label class="feature-item"><input type="checkbox" class="rep-feat" value="Panjur"> Panjur</label>
                <label class="feature-item"><input type="checkbox" class="rep-feat" value="DuÅŸakabin"> DuÅŸakabin</label>
            </div>
            <div style="font-weight:bold; margin-top:10px;">DÄ±ÅŸ & Site:</div>
            <div class="feature-grid">
                <label class="feature-item"><input type="checkbox" class="rep-feat" value="AsansÃ¶r"> AsansÃ¶r</label>
                <label class="feature-item"><input type="checkbox" class="rep-feat" value="Otopark"> Otopark</label>
                <label class="feature-item"><input type="checkbox" class="rep-feat" value="Havuz"> Havuz</label>
                <label class="feature-item"><input type="checkbox" class="rep-feat" value="GÃ¼venlik"> GÃ¼venlik</label>
            </div>
        </div>

        <div id="rt-medya" class="report-pane">
            <div class="form-group">
                <label>Vitrin FotoÄŸrafÄ±</label>
                <input type="file" id="repPhotoInput" onchange="previewReportPhoto()">
                <img id="repPhotoPreview" style="max-width:300px; display:none; margin-top:10px; border-radius:5px; border:1px solid #ccc;">
                <input type="hidden" id="repPhotoData">
            </div>
            <hr>
            <div style="display:flex; gap:10px;">
                <button class="btn-save" onclick="saveReport()">ğŸ’¾ RAPORU KAYDET</button>
                <button class="btn-cancel" onclick="clearReportForm()">Temizle</button>
            </div>
        </div>

        <div id="rt-liste" class="report-pane">
            <h3>KayÄ±tlÄ± Raporlar</h3>
            <div id="reportListContainer"></div>
        </div>
    </div>
</div>

<div id="printArea">
    </div>

<div id="crmModal" class="modal" onclick="closeModalOutside(event, 'crmModal')">
    <div class="modal-content">
        <span class="modal-close" onclick="closeModal('crmModal')">&times;</span>
        <div class="modal-title">ğŸ‘¥ MÃ¼ÅŸteri Ä°liÅŸkileri (CRM)</div>
        <div class="report-tabs">
            <div class="report-tab active" onclick="switchCRMTab('crmInvestors')">ğŸ’° Talep Havuzu</div>
            <div class="report-tab" onclick="switchCRMTab('crmNetwork')">ğŸ“¢ Etki Ã‡evresi</div>
        </div>
        <div id="crmInvestors" class="report-pane active">
            <div class="form-grid">
                <div class="form-group"><label>Ad Soyad</label><input type="text" id="invName"></div>
                <div class="form-group"><label>Tel</label><input type="text" id="invPhone"></div>
                <div class="form-group"><label>Talep</label><input type="text" id="invRequest"></div>
                <button class="btn-save" onclick="saveCRMInvestor()">EKLE</button>
            </div>
            <table class="crm-table"><thead><tr><th>Ä°sim</th><th>Tel</th><th>Talep</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="investorTableBody"></tbody></table>
        </div>
        <div id="crmNetwork" class="report-pane">
            <div class="form-grid">
                <div class="form-group"><label>Ad Soyad</label><input type="text" id="netName"></div>
                <div class="form-group"><label>Tel</label><input type="text" id="netPhone"></div>
                <button class="btn-save" onclick="saveCRMNetwork()">EKLE</button>
            </div>
            <table class="crm-table"><thead><tr><th>Ä°sim</th><th>Tel</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="networkTableBody"></tbody></table>
        </div>
    </div>
</div>

<div id="calcModal" class="modal" onclick="closeModalOutside(event, 'calcModal')"><div class="modal-content" style="width:350px;"><span class="modal-close" onclick="closeModal('calcModal')">&times;</span><h3>ğŸ§® Hesap Makinesi</h3><input type="text" id="calcDisplay" style="width:100%; padding:10px; margin-bottom:10px; font-size:20px; text-align:right;"><div style="display:grid; grid-template-columns:repeat(4,1fr); gap:5px;"><button onclick="calcIn('7')">7</button><button onclick="calcIn('8')">8</button><button onclick="calcIn('9')">9</button><button onclick="calcIn('/')">/</button><button onclick="calcIn('4')">4</button><button onclick="calcIn('5')">5</button><button onclick="calcIn('6')">6</button><button onclick="calcIn('*')">*</button><button onclick="calcIn('1')">1</button><button onclick="calcIn('2')">2</button><button onclick="calcIn('3')">3</button><button onclick="calcIn('-')">-</button><button onclick="calcIn('0')">0</button><button onclick="calcIn('.')">.</button><button onclick="calcClr()">C</button><button onclick="calcRes()">=</button></div></div></div>
<div id="currencyModal" class="modal" onclick="closeModalOutside(event, 'currencyModal')"><div class="modal-content" style="width:400px;"><span class="modal-close" onclick="closeModal('currencyModal')">&times;</span><h3>ğŸ’± DÃ¶viz</h3><div id="currRates" style="margin-bottom:10px;">YÃ¼kleniyor...</div><input type="number" id="currAmt" placeholder="Tutar"><select id="currType"><option value="USD">USD</option><option value="EUR">EUR</option></select><button class="btn-save" onclick="calcCurr()">Ã‡evir</button><div id="currRes" style="font-size:20px; font-weight:bold; margin-top:10px;"></div></div></div>
<div id="descModal" class="modal" onclick="closeModalOutside(event, 'descModal')"><div class="modal-content"><span class="modal-close" onclick="closeModal('descModal')">&times;</span><h3>ğŸ“ Not</h3><p id="modalText" style="white-space: pre-wrap;"></p></div></div>

<script>
    // --- GÄ°RÄ°Å ---
    function checkLogin() { if(document.getElementById('loginPin').value==="1923"){document.getElementById('loginOverlay').style.display='none';document.getElementById('appContainer').style.display='block'; window.scrollTo(0,0);}else{alert("HatalÄ± Åifre!");} }

    // --- GENEL VERÄ°LER ---
    const antalyaData = { "Akseki": ["Merkez"], "Aksu": ["AltÄ±ntaÅŸ","Kundu","Macun"], "Alanya": ["Merkez","Mahmutlar"], "DÃ¶ÅŸemealtÄ±": ["YenikÃ¶y","YeÅŸilbayÄ±r"], "Kepez": ["Varsak","KÃ¼ltÃ¼r"], "KonyaaltÄ±": ["Liman","Hurma","UncalÄ±"], "MuratpaÅŸa": ["Lara","Fener","ÅirinyalÄ±"], "Serik": ["Belek","Kadriye"] };
    const floorList = ["GiriÅŸ","1","2","3","4","5","6","7","8","9","10+","Ã‡atÄ± Dubleks","BahÃ§e Dubleks"];
    const roomList = ["1+1","2+1","3+1","4+1","Villa","Ofis"];
    const typeList = ["Daire","Villa","Arsa","Ä°ÅŸyeri","Turistik"];

    // DB
    let portfolio = JSON.parse(localStorage.getItem('KaracabayRE_EST_DB_v19')) || [];
    let reportDB = JSON.parse(localStorage.getItem('KaracabayRE_REPORT_DB')) || []; // DetaylÄ± Rapor DB
    let crmData = JSON.parse(localStorage.getItem('KaracabayRE_CRM_v19')) || { investors: [], network: [] };
    let editingId = null; 
    let map = null, marker = null;

    window.onload = function() { populateSelects(); renderTable(); };

    // --- HELPER ---
    function formatCurrency(input) { let v=input.value.replace(/\D/g, ''); input.value=v.replace(/\B(?=(\d{3})+(?!\d))/g, "."); }
    function parsePrice(v) { return v ? parseInt(v.toString().replace(/\./g,'')) : 0; }
    function autoResize(el) { el.style.height = 'auto'; el.style.height = el.scrollHeight + 'px'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; document.body.classList.remove('no-scroll'); }
    function closeModalOutside(e, id) { if(e.target == document.getElementById(id)) closeModal(id); }
    function openModal(id) { document.getElementById(id).style.display = 'block'; document.body.classList.add('no-scroll'); }

    // --- ANA PORTFÃ–Y (HIZLI LÄ°STE) ---
    function handleSave() {
        const data = {
            id: editingId ? editingId : Date.now(),
            type: document.getElementById('inpType').value, status: document.getElementById('inpStatus').value,
            district: document.getElementById('inpDistrict').value, neighborhood: document.getElementById('inpNeighborhood').value,
            rooms: document.getElementById('inpRooms').value, floor: document.getElementById('inpFloor').value, floorCount: document.getElementById('inpFloorCount').value,
            gross: document.getElementById('inpGross').value, net: document.getElementById('inpNet').value,
            price: document.getElementById('inpPrice').value, currency: document.getElementById('inpCurrency').value,
            authStart: document.getElementById('inpAuthStart').value, authEnd: document.getElementById('inpAuthEnd').value,
            ref: document.getElementById('inpRef').value, phone: document.getElementById('inpPhone').value,
            link: document.getElementById('inpLink').value, desc: document.getElementById('inpDesc').value
        };
        if(!data.district || !data.price) { alert("Ä°lÃ§e ve Fiyat zorunlu!"); return; }
        if (editingId) portfolio[portfolio.findIndex(p => p.id === editingId)] = data; else portfolio.push(data);
        saveDB(); renderTable(); resetForm();
    }
    function renderTable() {
        const tbody = document.getElementById('tableBody'); tbody.innerHTML = '';
        const term = document.getElementById('searchBox').value.toLowerCase();
        const fStat = document.getElementById('filterStatus').value;
        portfolio.forEach(item => {
            if(fStat !== 'all' && item.status !== fStat) return;
            if(!JSON.stringify(item).toLowerCase().includes(term)) return;
            let badge = item.status.includes('SatÄ±ldÄ±') ? 'kirmizi-etiket' : (item.status==='KiralÄ±k'?'kiralik':'satilik');
            tbody.innerHTML += `<tr><td><span class="badge ${badge}">${item.status}</span><br><small>${item.type}</small></td><td><b>${item.district}</b><br><small>${item.neighborhood}</small></td><td>${item.rooms}</td><td>${item.gross} mÂ²</td><td style="color:#27ae60;">${item.price} ${item.currency}</td><td>${item.ref}</td><td>-</td><td>-</td><td>-</td><td><button onclick="editRec(${item.id})">DÃ¼zenle</button></td></tr>`;
        });
    }
    function editRec(id) { const item = portfolio.find(p=>p.id===id); if(!item) return; editingId=id; document.getElementById('inpDistrict').value=item.district; document.getElementById('inpPrice').value=item.price; document.getElementById('formTitle').innerText="DÃ¼zenleniyor..."; }
    function deleteFromForm() { if(confirm('Sil?')) { portfolio = portfolio.filter(p=>p.id!==editingId); saveDB(); resetForm(); } }
    function resetForm() { editingId=null; document.getElementById('formTitle').innerText="âš¡ HÄ±zlÄ± PortfÃ¶y Ekle"; document.querySelectorAll('.input-panel input').forEach(i=>i.value=''); renderTable(); }
    function saveDB() { localStorage.setItem('KaracabayRE_EST_DB_v19', JSON.stringify(portfolio)); }

    // --- RAPOR MODÃœLÃœ (v3.8 Logic) ---
    function openReportModule() { openModal('reportModal'); if(!map) initMap(); }
    function switchReportTab(id) { document.querySelectorAll('.report-pane').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); document.querySelectorAll('.report-tab').forEach(t=>t.classList.remove('active')); event.target.classList.add('active'); }
    function initMap() { 
        map = L.map('map').setView([36.8841, 30.7056], 10); 
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        map.on('click', function(e) { 
            if(marker) map.removeLayer(marker); 
            marker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map); 
            document.getElementById('repLat').value = e.latlng.lat; 
            document.getElementById('repLng').value = e.latlng.lng; 
        });
    }
    function resizeMap() { setTimeout(()=>{ map.invalidateSize(); }, 300); }
    function getLocation() { if(navigator.geolocation) navigator.geolocation.getCurrentPosition(p=>{ map.setView([p.coords.latitude, p.coords.longitude], 15); }); }
    function previewReportPhoto() { const f = document.getElementById('repPhotoInput').files[0]; const r = new FileReader(); r.onload=e=>{ document.getElementById('repPhotoPreview').src=e.target.result; document.getElementById('repPhotoPreview').style.display='block'; document.getElementById('repPhotoData').value=e.target.result; }; if(f) r.readAsDataURL(f); }

    function saveReport() {
        const id = document.getElementById('repId').value || 'REP'+Date.now();
        const report = {
            id,
            owner: document.getElementById('repOwner').value, phone: document.getElementById('repPhone').value,
            title: document.getElementById('repTitle').value, price: document.getElementById('repPrice').value, curr: document.getElementById('repCurr').value,
            desc: document.getElementById('repDesc').value, gross: document.getElementById('repGross').value, net: document.getElementById('repNet').value,
            room: document.getElementById('repRoom').value, lat: document.getElementById('repLat').value, lng: document.getElementById('repLng').value,
            city: document.getElementById('repCity').value, district: document.getElementById('repDistrict').value, neigh: document.getElementById('repNeigh').value,
            features: [...document.querySelectorAll('.rep-feat:checked')].map(c=>c.value),
            photo: document.getElementById('repPhotoData').value
        };
        const idx = reportDB.findIndex(r=>r.id===id); if(idx>-1) reportDB[idx]=report; else reportDB.push(report);
        localStorage.setItem('KaracabayRE_REPORT_DB', JSON.stringify(reportDB));
        alert('Rapor Kaydedildi!'); clearReportForm(); loadReportList(); switchReportTab('rt-liste');
    }
    
    function loadReportList() {
        const c = document.getElementById('reportListContainer'); c.innerHTML = '';
        reportDB.forEach(r => {
            c.innerHTML += `<div class="report-list-item">
                <div><b>${r.title}</b> <br> ${r.price} ${r.curr}</div>
                <div>
                    <button class="btn-save" style="background:#3498db; padding:5px;" onclick="viewReport('${r.id}', false)">ğŸ‘ï¸ MÃ¼ÅŸteri</button>
                    <button class="btn-save" style="background:#f1c40f; color:#333; padding:5px;" onclick="viewReport('${r.id}', true)">ğŸ”’ YÃ¶netici</button>
                    <button class="btn-cancel" style="padding:5px;" onclick="deleteReport('${r.id}')">Sil</button>
                </div>
            </div>`;
        });
    }

    function viewReport(id, isAdmin) {
        const r = reportDB.find(x => x.id === id); if(!r) return;
        let adminInfo = isAdmin ? `<div class="admin-box"><b>ğŸ”’ YÃ–NETÄ°CÄ° BÄ°LGÄ°SÄ°:</b><br>Mal Sahibi: ${r.owner} | Tel: ${r.phone}</div>` : '';
        let feats = r.features.map(f=>`<span class="feature-tag">${f}</span>`).join(' ');
        let img = r.photo ? `<img src="${r.photo}" style="max-width:100%; border-radius:8px; margin-bottom:20px;">` : '';
        
        let html = `
            <div style="max-width:800px; margin:0 auto; background:white; padding:30px;">
                ${adminInfo}
                <h1 style="color:#2c3e50;">${r.title}</h1>
                <div class="doc-price">${r.price} ${r.curr}</div>
                <hr>
                <div style="display:flex; gap:20px;">
                    <div style="flex:1;">${img} <p>${r.desc}</p></div>
                    <div style="flex:1; background:#f9f9f9; padding:15px; border-radius:8px;">
                        <p><span class="doc-label">Konum:</span> ${r.city}/${r.district}/${r.neigh}</p>
                        <p><span class="doc-label">BÃ¼yÃ¼klÃ¼k:</span> ${r.gross} mÂ² / ${r.net} mÂ²</p>
                        <p><span class="doc-label">Oda:</span> ${r.room}</p>
                        <hr>
                        <div>${feats}</div>
                    </div>
                </div>
                <div style="text-align:center; margin-top:30px; font-size:11px; color:#999;">KaracabayRE.EST Rapor Sistemi</div>
            </div>
            <div class="no-print" style="position:fixed; bottom:20px; right:20px;">
                <button onclick="window.print()" style="padding:15px 30px; background:#2c3e50; color:white; font-size:18px; border:none; border-radius:5px; cursor:pointer;">ğŸ–¨ï¸ YAZDIR / PDF</button>
                <button onclick="document.getElementById('printArea').style.display='none'; document.getElementById('appContainer').style.display='block';" style="padding:15px; background:#c0392b; color:white; border:none; border-radius:5px;">KAPAT</button>
            </div>
        `;
        document.getElementById('printArea').innerHTML = html;
        document.getElementById('appContainer').style.display = 'none'; // Ana ekranÄ± gizle
        document.getElementById('printArea').style.display = 'block'; // Raporu gÃ¶ster
        closeModal('reportModal');
    }
    function deleteReport(id) { if(confirm('Sil?')) { reportDB=reportDB.filter(r=>r.id!==id); localStorage.setItem('KaracabayRE_REPORT_DB', JSON.stringify(reportDB)); loadReportList(); } }
    function clearReportForm() { document.getElementById('repId').value=''; document.querySelectorAll('#reportModal input, #reportModal textarea').forEach(i=>i.value=''); document.querySelectorAll('.rep-feat').forEach(c=>c.checked=false); document.getElementById('repPhotoPreview').style.display='none'; }

    // --- DATA EXPORT/IMPORT ---
    function downloadData() { 
        const data = { portfolio, crm: crmData, reports: reportDB };
        const blob = new Blob([JSON.stringify(data)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Karacabay_FULL_BACKUP.json'; a.click(); 
    }
    function uploadData(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader(); reader.onload = function(e) {
            const d = JSON.parse(e.target.result);
            if(d.portfolio) portfolio = d.portfolio;
            if(d.reports) reportDB = d.reports;
            if(d.crm) crmData = d.crm;
            saveDB(); localStorage.setItem('KaracabayRE_REPORT_DB', JSON.stringify(reportDB));
            alert("YÃ¼klendi!"); location.reload();
        }; reader.readAsText(file);
    }
    
    // --- POPULATE ---
    function populateSelects() {
        const dS=document.getElementById('inpDistrict'), fS=document.getElementById('filterDistrict');
        Object.keys(antalyaData).forEach(d=>{ dS.innerHTML+=`<option>${d}</option>`; fS.innerHTML+=`<option>${d}</option>`; });
        const rS=document.getElementById('inpRooms'); roomList.forEach(r=>rS.innerHTML+=`<option>${r}</option>`);
        const tS=document.getElementById('inpType'), tF=document.getElementById('filterType'); typeList.forEach(t=>{ tS.innerHTML+=`<option>${t}</option>`; tF.innerHTML+=`<option>${t}</option>`; });
        const fL=document.getElementById('inpFloor'); floorList.forEach(f=>fL.innerHTML+=`<option>${f}</option>`);
    }
    function loadMahalleler(s,t) { const v=document.getElementById(s).value, d=document.getElementById(t); d.innerHTML=''; if(antalyaData[v]) antalyaData[v].forEach(m=>{let o=document.createElement('option');o.value=m;d.appendChild(o);}); }

    // --- BASÄ°T ARAÃ‡LAR ---
    let calcExp=""; function calcIn(v){calcExp+=v;document.getElementById('calcDisplay').value=calcExp;} function calcRes(){try{document.getElementById('calcDisplay').value=eval(calcExp)}catch(e){}} function calcClr(){calcExp="";document.getElementById('calcDisplay').value=""}
    async function fetchCurrency(){try{let r=await fetch('https://api.exchangerate-api.com/v4/latest/TRY');let d=await r.json();document.getElementById('currRates').innerText=`USD: ${(1/d.rates.USD).toFixed(2)} | EUR: ${(1/d.rates.EUR).toFixed(2)}`; window.currData=d;}catch(e){}}
    function calcCurr(){let a=document.getElementById('currAmt').value, t=document.getElementById('currType').value; if(window.currData){let r=1/window.currData.rates[t]; document.getElementById('currRes').innerText=(a*r).toFixed(2)+" TL";}}
    // CRM
    function switchCRMTab(id) { document.getElementById('crmInvestors').style.display='none'; document.getElementById('crmNetwork').style.display='none'; document.getElementById(id).style.display='block'; }
    function saveCRMInvestor() { crmData.investors.push({name:document.getElementById('invName').value, phone:document.getElementById('invPhone').value}); localStorage.setItem('KaracabayRE_CRM_v19', JSON.stringify(crmData)); alert('Eklendi'); }
</script>
</body>
</html>
